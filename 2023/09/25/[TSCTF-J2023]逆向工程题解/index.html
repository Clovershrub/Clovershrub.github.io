<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>[TSCTF-J2023]逆向工程题解 | Clovershrub</title><meta name="author" content="Clovershrub"><meta name="copyright" content="Clovershrub"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="[TSCTF-J2023]逆向工程题解 前言 TSCTF-J2023 Reverse试题落实立德树人根本任务，遵循德智体美劳全面发展要求，贯彻《深化新时代CTF改革总体方案》，体现了TSCTF-J改革的方向。试卷突出逆向工程学科特点，加强基础性与关键能力考查，充分发挥逆向工程学科的选拔与引导功能。TSCTF-J2023 Reverse坚持立德树人，体现CTF文化的育人价值，突出理性思维的价值，注重">
<meta property="og:type" content="article">
<meta property="og:title" content="[TSCTF-J2023]逆向工程题解">
<meta property="og:url" content="https://clovershrub.github.io/2023/09/25/[TSCTF-J2023]%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/index.html">
<meta property="og:site_name" content="Clovershrub">
<meta property="og:description" content="[TSCTF-J2023]逆向工程题解 前言 TSCTF-J2023 Reverse试题落实立德树人根本任务，遵循德智体美劳全面发展要求，贯彻《深化新时代CTF改革总体方案》，体现了TSCTF-J改革的方向。试卷突出逆向工程学科特点，加强基础性与关键能力考查，充分发挥逆向工程学科的选拔与引导功能。TSCTF-J2023 Reverse坚持立德树人，体现CTF文化的育人价值，突出理性思维的价值，注重">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://clovershrub.github.io/img/[TSCTF-J2023]%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/cover.jpg">
<meta property="article:published_time" content="2023-09-24T16:00:00.000Z">
<meta property="article:modified_time" content="2024-09-23T09:03:28.064Z">
<meta property="article:author" content="Clovershrub">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://clovershrub.github.io/img/[TSCTF-J2023]%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/cover.jpg"><link rel="shortcut icon" href="/img/blogs/avatar.jpg"><link rel="canonical" href="https://clovershrub.github.io/2023/09/25/[TSCTF-J2023]%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '[TSCTF-J2023]逆向工程题解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-23 17:03:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Clovershrub" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/blogs/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/cover.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Clovershrub"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">[TSCTF-J2023]逆向工程题解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2023-09-24T16:00:00.000Z" title="Created 2023-09-25 00:00:00">2023-09-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="[TSCTF-J2023]逆向工程题解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="tsctf-j2023-逆向工程题解">[TSCTF-J2023]逆向工程题解</h1>
<h2 id="前言">前言</h2>
<p>TSCTF-J2023 Reverse试题<s>落实立德树人根本任务，遵循德智体美劳全面发展要求，贯彻《深化新时代CTF改革总体方案》，体现了TSCTF-J改革的方向。试卷突出逆向工程学科特点，加强基础性与关键能力考查，充分发挥逆向工程学科的选拔与引导功能。TSCTF-J2023 Reverse坚持立德树人，体现CTF文化的育人价值，突出理性思维的价值，注重计算机基础性，引导学生对CTF概念、方法更深刻的认知，在基础性、综合性、应用性、创新性等方面都进行了深入的考查。试题稳中有变，变中有新，难度设计科学。</s> 较好地发挥了TSCTF-J的选拔功能，对萌新学习逆向知识发挥了积极的引导和促进作用。<br>
<a href="/file/TSCTF-J2023.zip">题目在此</a></p>
<h2 id="the-path">The_Path</h2>
<p>不知道各位在做这道题的时候有什么想法，反正我是挺想骂街的。添加了与[2019红帽杯]easyRE一样的主动防御。本着不能只有我一个人受苦的优良品德，出了这道题。打开看见：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Path1.png" alt=""><br>
给人感官极其良好，但是稍微往左瞥一眼就会看见：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Path2.png" alt=""><br>
是的，我创造了50000个函数。根据提示摁下shift+F12可以根据特殊字符串找到：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Path3.png" alt=""><br>
然而，解完却得到了https://bbs.kanxue.com/thread-254172.htm。 非常好，被骗了。观察数据可以发现在key和ans上面存在着enc和box两个没用到但已初始化的数组：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Path4.png" alt=""><br>
跟进可以找到真正的加密函数：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Path5.png" alt=""><br>
解得flag：TSCTF-J{Welcome_to_TSCTF-J_reverser!}<br>
将文件用010editor打开可以在最后看见彩蛋：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Path6.png" alt=""></p>
<h2 id="the-encryption">The_Encryption</h2>
<p>这道题很繁琐，很傻逼。打开看见：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Encryption1.png" alt=""><br>
根据他们在栈上的位置可以改改名字：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Encryption2.png" alt=""><br>
点进去可以看出encrypt1是变表的base64加密，encrypt2是TEA，encrypt3是RC4。用我们小学二年级就会的代码可以写出来：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> base64char[<span class="number">100</span>] = <span class="string">&quot;AKLMNOPQRbGH34ScdefghIJvwxyz012ijklmnopqVWXYZa56789+/rstuBCDEFTU&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">base64_decode</span><span class="params">(<span class="type">char</span> *base64, <span class="type">char</span> *originChar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 temp[<span class="number">4</span>]; <span class="comment">// [rsp+23h] [rbp-Dh] BYREF</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 k; <span class="comment">// [rsp+27h] [rbp-9h]</span></span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( base64[i] )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(temp, <span class="number">255</span>, <span class="built_in">sizeof</span>(temp));</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">0x3F</span>u; ++k )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( base64char[k] == base64[i] )</span><br><span class="line">                temp[<span class="number">0</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">0x3F</span>u; ++k )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( base64char[k] == base64[i + <span class="number">1</span>] )</span><br><span class="line">                temp[<span class="number">1</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">0x3F</span>u; ++k )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( base64char[k] == base64[i + <span class="number">2</span>] )</span><br><span class="line">                temp[<span class="number">2</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">0x3F</span>u; ++k )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( base64char[k] == base64[i + <span class="number">3</span>] )</span><br><span class="line">                temp[<span class="number">3</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">        v2 = j++;</span><br><span class="line">        originChar[v2] = (temp[<span class="number">1</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span> | (<span class="number">4</span> * temp[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> ( base64[i + <span class="number">2</span>] == <span class="number">61</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        v3 = j++;</span><br><span class="line">        originChar[v3] = (temp[<span class="number">2</span>] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xF</span> | (<span class="number">16</span> * temp[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> ( base64[i + <span class="number">3</span>] == <span class="number">61</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        v4 = j++;</span><br><span class="line">        originChar[v4] = temp[<span class="number">3</span>] &amp; <span class="number">0x3F</span> | (temp[<span class="number">2</span>] &lt;&lt; <span class="number">6</span>);</span><br><span class="line">        i += <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TEA_decrypt</span><span class="params">(<span class="type">char</span> * s2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sum = <span class="number">0</span>, v0 = <span class="number">0</span>, v1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> delta = <span class="number">0x61C88647</span>, k[<span class="number">5</span>] = &#123;<span class="number">1029</span>, <span class="number">3847</span>, <span class="number">5674</span>, <span class="number">8392</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        v0 = v0 * <span class="number">256</span> + (s2[i] &amp; <span class="number">0xff</span>);<span class="comment">//注意这里，这个地方很玄学。如果你在这个for之前将s2[]输出出来，你会发现前几位都是负数。</span></span><br><span class="line">        v1 = v1 * <span class="number">256</span> + (s2[i+<span class="number">4</span>] &amp; <span class="number">0xff</span>);<span class="comment">//不加这个变化历程会是ffffffab -&gt; ffffaaa7 -&gt; ffaaa722 -&gt; aaa7219b，有很明显的错误。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sum -= delta;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        v1 -= (v0 + sum) ^ (<span class="number">16</span> * v0 + k[<span class="number">2</span>]) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k[<span class="number">3</span>]);</span><br><span class="line">        v0 -= (v1 + sum) ^ (<span class="number">16</span> * v1 + k[<span class="number">0</span>]) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k[<span class="number">1</span>]);</span><br><span class="line">        sum += delta;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        s2[i] = v0 % <span class="number">256</span>;</span><br><span class="line">        s2[i+<span class="number">4</span>] = v1 % <span class="number">256</span>;</span><br><span class="line">        v0 /= <span class="number">256</span>;</span><br><span class="line">        v1 /= <span class="number">256</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, s2[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rc4_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *s, <span class="type">unsigned</span> <span class="type">char</span> *key, <span class="type">unsigned</span> <span class="type">long</span> Len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> k[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;<span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s[i] = i;</span><br><span class="line">        k[i] = key[i%Len];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;<span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        j = (j + s[i] + k[i]) % <span class="number">256</span>;</span><br><span class="line">        tmp = s[i];</span><br><span class="line">        s[i] = s[j];</span><br><span class="line">        s[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rc4_crypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *s, <span class="type">unsigned</span> <span class="type">char</span> *Data, <span class="type">unsigned</span> <span class="type">long</span> Len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, t = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> k = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;Len; k++)</span><br><span class="line">    &#123;</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span>;</span><br><span class="line">        tmp = s[i];</span><br><span class="line">        s[i] = s[j];</span><br><span class="line">        s[j] = tmp;</span><br><span class="line">        t = (s[i] + s[j]) % <span class="number">256</span>;</span><br><span class="line">        Data[k] ^= s[t];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> randint[<span class="number">99</span>] = &#123;<span class="number">0x19</span>, <span class="number">0x78</span>, <span class="number">0x38</span>, <span class="number">0xa</span>, <span class="number">0xc7</span>, <span class="number">0x77</span>, <span class="number">0x89</span>, <span class="number">0x41</span>, <span class="number">0xdc</span>, <span class="number">0xf4</span>, <span class="number">0xa1</span>, <span class="number">0xa0</span>, <span class="number">0x21</span>, <span class="number">0xfe</span>, <span class="number">0x29</span>, <span class="number">0x79</span>, <span class="number">0x6</span>, <span class="number">0x63</span>, <span class="number">0x5f</span>, <span class="number">0x1c</span>, <span class="number">0x2f</span>, <span class="number">0x14</span>, <span class="number">0x4f</span>, <span class="number">0xd2</span>, <span class="number">0xb2</span>, <span class="number">0x83</span>, <span class="number">0xa2</span>, <span class="number">0xaa</span>&#125;;</span><br><span class="line">    <span class="type">int</span> dis[<span class="number">99</span>] = &#123;<span class="number">-94</span>,<span class="number">46</span>,<span class="number">-54</span>,<span class="number">-107</span>,<span class="number">150</span>,<span class="number">10</span>,<span class="number">85</span>,<span class="number">-32</span>,<span class="number">169</span>,<span class="number">163</span>,<span class="number">75</span>,<span class="number">99</span>,<span class="number">118</span>,<span class="number">343</span>,<span class="number">7</span>,<span class="number">222</span>,<span class="number">-87</span>,<span class="number">204</span>,<span class="number">162</span>,<span class="number">133</span>,<span class="number">13</span>,<span class="number">-47</span>,<span class="number">135</span>,<span class="number">318</span>,<span class="number">235</span>,<span class="number">243</span>,<span class="number">147</span>,<span class="number">176</span>&#125;;</span><br><span class="line">    <span class="type">char</span> ans[<span class="number">99</span>], s1[<span class="number">15</span>], s2[<span class="number">15</span>], s3[<span class="number">15</span>], de64[<span class="number">15</span>] = &#123;&#125;;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">28</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ans[i] = randint[i] - dis[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s1[i] = ans[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">12</span>; i &lt; <span class="number">20</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s2[i<span class="number">-12</span>] = ans[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">20</span>; i &lt; <span class="number">28</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s3[i<span class="number">-20</span>] = ans[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">base64_decode</span>(s1, de64);</span><br><span class="line">    cout &lt;&lt; de64 &lt;&lt; <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">    <span class="built_in">TEA_decrypt</span>(s2);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> s[<span class="number">256</span>] = &#123;&#125;;</span><br><span class="line">    <span class="type">char</span> key[<span class="number">99</span>] = <span class="string">&quot;It&#x27;s_almost_done&quot;</span>;</span><br><span class="line">    <span class="built_in">rc4_init</span>(s, (<span class="type">unsigned</span> <span class="type">char</span> *)key, <span class="built_in">strlen</span>(key));</span><br><span class="line">    <span class="built_in">rc4_crypt</span>(s, (<span class="type">unsigned</span> <span class="type">char</span>*)s3, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; s3[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到flag：TSCTF-J{ai8v3m0z-2kf6cj1a-74bfuzx6}<br>
想不到吧，flag是乱码，哈哈哈哈哈哈。</p>
<h2 id="the-gobang">The_GoBang</h2>
<p>C#逆向，逆向软件使用dnSpy。不推荐运行附件，攻击性挺强的。<br>
在GoBang命名空间，Flag类中找到GetFlag方法：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_GoBang1.png" alt=""><br>
这个算法乍一看好像并不可逆，但仔细观察可以发现如果执行if块，得到的必定是偶数，如果执行else块，得到的必定是奇数。<br>
据此可以写出代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> s = <span class="number">0x1C888E368C54BA0F</span>;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(s &amp; <span class="number">1</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            s = (s ^ <span class="number">-5557806387376563891</span>);</span><br><span class="line">            s &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">            s |= <span class="number">0x8000000000000000</span>;<span class="comment">//强转为负数</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            s = s &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            s &amp;= <span class="number">0x7fffffffffffffff</span>;<span class="comment">//强转为正数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; s;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>据此可以得到7677464758678594。<br>
根据GoBang命名空间，Form1类panel2_MouseDown方法可以知道这串数其实是下棋的点位。<br>
运行得到flag：TSCTF-J{F760CE18031A7492160EB3C6742C68A1}<br>
不想运行直接MD5也是可以的。<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_GoBang2.png" alt=""></p>
<h2 id="the-step">The_Step</h2>
<p>此题考查选手动态调试的能力。打开之后改改名字看见：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Step1.png" alt=""><br>
main函数戛然而止必定不对劲，选择动态调试。发现进入：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Step2.png" alt=""><br>
接着进行可以发现进入：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Step3.png" alt=""><br>
查看off_4C4018可以发现它其实是array[10]。<br>
接着进行可以发现进入：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Step4.png" alt=""><br>
此时，要么硬读汇编，要么全选之后摁P，再摁F5，就能看见伪代码。<br>
接着进行可以发现进入：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Step5.png" alt=""><br>
执行完4C110B的代码后将鼠标放在edx上可以发现edx其实就是array。<br>
接着进行可以发现进入：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Step6.png" alt=""><br>
这里就是对比数据了。至此，我们可以写出代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> s[<span class="number">40</span>] = &#123;<span class="number">4188</span>, <span class="number">4178</span>, <span class="number">4139</span>, <span class="number">4191</span>, <span class="number">4166</span>, <span class="number">3872</span>, <span class="number">3996</span>, <span class="number">4088</span>, <span class="number">3893</span>, <span class="number">3813</span>, <span class="number">3947</span>, <span class="number">4634</span>, <span class="number">4485</span>, <span class="number">4508</span>, <span class="number">4319</span>, <span class="number">4212</span>, <span class="number">3311</span>, <span class="number">3311</span>, <span class="number">3027</span>, <span class="number">2909</span>, <span class="number">3503</span>, <span class="number">3312</span>, <span class="number">3290</span>, <span class="number">5207</span>, <span class="number">5055</span>, <span class="number">5642</span>, <span class="number">5606</span>, <span class="number">5094</span>, <span class="number">4118</span>, <span class="number">3782</span>, <span class="number">4401</span>, <span class="number">4322</span>, <span class="number">119</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">33</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s[i] += i * i;</span><br><span class="line">        s[i] /= <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">10</span>; i &lt; <span class="number">27</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s[i] -= <span class="number">0x34</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">33</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s[i] ^= i * (i + <span class="number">1</span>);</span><br><span class="line">        s[i] ^= <span class="number">0x520</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, s[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行得到flag：TSCTF-J{Oh_You_CAn_ReAlLY_dAnCe!}</p>
<h2 id="the-magic">The_Magic</h2>
<p>TLS回调函数+SEH异常处理。<br>
跟进线程会解出TSCTF-J{You_are_too_young_too_naive!}。同时在main和thread中下断点均断不住程序。根据提示找到TLS回调函数：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Magic1.png" alt=""><br>
第一段是进行33位的输入。找到第二段：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Magic2.png" alt=""><br>
可以找到加密部分。但是如此解密会得到一串乱码。如果你尝试过动调，会发现程序在不停地报错，但是如果选择将错误反馈给程序又能继续执行。根据提示查看汇编，找到try-except块：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Magic3.png" alt=""><br>
由于except块不在正常的程序执行流程当中，因此IDA会在分析伪代码的时候将其忽略。接下来可以硬读汇编或者让某一个跳转语句跳转到except块，然后再F5看伪代码。总之，可以写出脚本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> Seed = <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getrand</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Seed = (Seed + <span class="number">1029</span>) * <span class="number">3847</span> % <span class="number">5665</span>;</span><br><span class="line">    <span class="keyword">return</span> Seed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> enc[<span class="number">100</span>] = &#123; <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="number">111</span>, <span class="number">186</span>, <span class="number">117</span>, <span class="number">71</span>, <span class="number">44</span>, <span class="number">54</span>, <span class="number">93</span>, <span class="number">43</span>, <span class="number">179</span>, <span class="number">68</span>, <span class="number">158</span>, <span class="number">25</span>, <span class="number">145</span>, <span class="number">107</span>, <span class="number">229</span>, <span class="number">146</span>, <span class="number">220</span>, <span class="number">128</span>, <span class="number">220</span>, <span class="number">203</span>, <span class="number">195</span>, <span class="number">73</span>, <span class="number">179</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="string">&#x27;&#125;&#x27;</span> &#125;;</span><br><span class="line">    <span class="type">int</span> Xor[<span class="number">100</span>] = &#123; <span class="number">611</span>, <span class="number">613</span>, <span class="number">709</span>, <span class="number">611</span>, <span class="number">591</span>, <span class="number">589</span>, <span class="number">599</span>, <span class="number">597</span>, <span class="number">4732</span>, <span class="number">2686</span>, <span class="number">1877</span>, <span class="number">2929</span>, <span class="number">2678</span>, <span class="number">7275</span>, <span class="number">5979</span>, <span class="number">3657</span>, <span class="number">3879</span>, <span class="number">8962</span>, <span class="number">7445</span>, <span class="number">2694</span>, <span class="number">3384</span>, <span class="number">3710</span>, <span class="number">4938</span>, <span class="number">2832</span>, <span class="number">2329</span>, <span class="number">4215</span>, <span class="number">3152</span>, <span class="number">4911</span>, <span class="number">6525</span>, <span class="number">3445</span>, <span class="number">2071</span>, <span class="number">5765</span>, <span class="number">3700</span>, <span class="number">3156</span>, <span class="number">4178</span>, <span class="number">7234</span>, <span class="number">3437</span>, <span class="number">2437</span>, <span class="number">5236</span>, <span class="number">7265</span>, <span class="number">5391</span>, <span class="number">6257</span>, <span class="number">5756</span>, <span class="number">3426</span>, <span class="number">3446</span>, <span class="number">7432</span>, <span class="number">3871</span>, <span class="number">3442</span>, <span class="number">2200</span>, <span class="number">589</span> &#125;;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TSCTF-J&#123;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">8</span>; i &lt;= <span class="number">32</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> randint = <span class="built_in">getrand</span>();</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">32</span>; j &lt; <span class="number">126</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> input = j;</span><br><span class="line">            input = (<span class="type">unsigned</span> <span class="type">char</span>)((input + <span class="number">520</span>) ^ (randint + <span class="number">996</span>));</span><br><span class="line">            <span class="keyword">if</span>(input &gt;&gt; <span class="number">7</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                input = (<span class="type">unsigned</span> <span class="type">char</span>)((input + <span class="number">123</span>) ^ (Xor[i] - <span class="number">456</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(input == enc[i])</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="built_in">char</span>(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行得出flag：TSCTF-J{Y0u_4r3_a_8r3at_m4g1cIan!}</p>
<h2 id="the-shell">The_Shell</h2>
<p>手脱UPX壳。根据<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1534675-1-1.html">提示的这篇文章</a>使用x64dbg手动脱壳。打开可以看见程序开头的一堆push已经被nop掉了，但我们仍然可以根据RSP的变化下断点运行，寻找大跳。<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Shell1.png" alt=""><br>
最后找到程序的OEP是0x4014E0。<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Shell2.png" alt=""><br>
修复转储后用IDA打开可以看见：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Shell3.png" alt=""><br>
这个非常简单，可以写出脚本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> add[<span class="number">50</span>] = &#123;<span class="number">4</span>, <span class="number">49</span>, <span class="number">40</span>, <span class="number">60</span>, <span class="number">200</span>, <span class="number">187</span>, <span class="number">77</span>, <span class="number">199</span>, <span class="number">117</span>, <span class="number">10</span>, <span class="number">157</span>, <span class="number">92</span>, <span class="number">104</span>, <span class="number">87</span>, <span class="number">132</span>, <span class="number">134</span>, <span class="number">147</span>, <span class="number">32</span>, <span class="number">145</span>, <span class="number">99</span>, <span class="number">42</span>, <span class="number">18</span>, <span class="number">208</span>, <span class="number">167</span>, <span class="number">159</span>, <span class="number">44</span>, <span class="number">84</span>, <span class="number">227</span>, <span class="number">209</span>, <span class="number">34</span>, <span class="number">19</span>, <span class="number">8</span>, <span class="number">129</span>, <span class="number">255</span>&#125;;</span><br><span class="line"><span class="type">int</span> ans[<span class="number">50</span>] = &#123;<span class="number">88</span>, <span class="number">132</span>, <span class="number">107</span>, <span class="number">144</span>, <span class="number">270</span>, <span class="number">232</span>, <span class="number">151</span>, <span class="number">322</span>, <span class="number">200</span>, <span class="number">127</span>, <span class="number">256</span>, <span class="number">196</span>, <span class="number">199</span>, <span class="number">184</span>, <span class="number">227</span>, <span class="number">232</span>, <span class="number">248</span>, <span class="number">129</span>, <span class="number">262</span>, <span class="number">215</span>, <span class="number">147</span>, <span class="number">120</span>, <span class="number">325</span>, <span class="number">275</span>, <span class="number">254</span>, <span class="number">127</span>, <span class="number">156</span>, <span class="number">296</span>, <span class="number">285</span>, <span class="number">110</span>, <span class="number">52</span>, <span class="number">41</span>, <span class="number">162</span>, <span class="number">380</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">34</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, ans[i] - add[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解得flag：TSCTF-J{Such_a_beautiful_SHELL!!!}<br>
在查找数据时可以找到彩蛋：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Shell4.png" alt=""></p>
<h2 id="the-art">The_Art</h2>
<p>代码自修改+花指令。<br>
打开后发现无法F5，且汇编指令只能看懂这些：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Art1.png" alt=""><br>
硬读汇编可知程序将接下来的代码段每一位异或了0x77。写出如下IDC脚本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;idc.idc&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0x40139c</span>; i &lt; <span class="number">0x40171f</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">PatchByte</span>(i, <span class="built_in">Byte</span>(i) ^ <span class="number">0x77</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而，依旧无法F5，查看汇编可以找到：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Art2.png" alt=""><br>
将E9改为90后终于可以F5了，可以看到：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Art3.png" alt=""><br>
很明显，这段代码并不完整，继续查看汇编可以找到：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Art4.png" alt=""><br>
将C3改为90后就可以得到最终的伪代码：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Art5.png" alt=""><br>
通过findcrypt插件可以知道程序使用的是SM4加密，我们的输入是秘钥的一部分。需要使得加密后的数据是v15。考虑爆破，写出如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> u8 unsigned char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> u32 unsigned long</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> u8 Sbox[<span class="number">256</span>] = &#123;</span><br><span class="line">	<span class="number">0xd6</span>,<span class="number">0x90</span>,<span class="number">0xe9</span>,<span class="number">0xfe</span>,<span class="number">0xcc</span>,<span class="number">0xe1</span>,<span class="number">0x3d</span>,<span class="number">0xb7</span>,<span class="number">0x16</span>,<span class="number">0xb6</span>,<span class="number">0x14</span>,<span class="number">0xc2</span>,<span class="number">0x28</span>,<span class="number">0xfb</span>,<span class="number">0x2c</span>,<span class="number">0x05</span>,</span><br><span class="line">	<span class="number">0x2b</span>,<span class="number">0x67</span>,<span class="number">0x9a</span>,<span class="number">0x76</span>,<span class="number">0x2a</span>,<span class="number">0xbe</span>,<span class="number">0x04</span>,<span class="number">0xc3</span>,<span class="number">0xaa</span>,<span class="number">0x44</span>,<span class="number">0x13</span>,<span class="number">0x26</span>,<span class="number">0x49</span>,<span class="number">0x86</span>,<span class="number">0x06</span>,<span class="number">0x99</span>,</span><br><span class="line">	<span class="number">0x9c</span>,<span class="number">0x42</span>,<span class="number">0x50</span>,<span class="number">0xf4</span>,<span class="number">0x91</span>,<span class="number">0xef</span>,<span class="number">0x98</span>,<span class="number">0x7a</span>,<span class="number">0x33</span>,<span class="number">0x54</span>,<span class="number">0x0b</span>,<span class="number">0x43</span>,<span class="number">0xed</span>,<span class="number">0xcf</span>,<span class="number">0xac</span>,<span class="number">0x62</span>,</span><br><span class="line">	<span class="number">0xe4</span>,<span class="number">0xb3</span>,<span class="number">0x1c</span>,<span class="number">0xa9</span>,<span class="number">0xc9</span>,<span class="number">0x08</span>,<span class="number">0xe8</span>,<span class="number">0x95</span>,<span class="number">0x80</span>,<span class="number">0xdf</span>,<span class="number">0x94</span>,<span class="number">0xfa</span>,<span class="number">0x75</span>,<span class="number">0x8f</span>,<span class="number">0x3f</span>,<span class="number">0xa6</span>,</span><br><span class="line">	<span class="number">0x47</span>,<span class="number">0x07</span>,<span class="number">0xa7</span>,<span class="number">0xfc</span>,<span class="number">0xf3</span>,<span class="number">0x73</span>,<span class="number">0x17</span>,<span class="number">0xba</span>,<span class="number">0x83</span>,<span class="number">0x59</span>,<span class="number">0x3c</span>,<span class="number">0x19</span>,<span class="number">0xe6</span>,<span class="number">0x85</span>,<span class="number">0x4f</span>,<span class="number">0xa8</span>,</span><br><span class="line">	<span class="number">0x68</span>,<span class="number">0x6b</span>,<span class="number">0x81</span>,<span class="number">0xb2</span>,<span class="number">0x71</span>,<span class="number">0x64</span>,<span class="number">0xda</span>,<span class="number">0x8b</span>,<span class="number">0xf8</span>,<span class="number">0xeb</span>,<span class="number">0x0f</span>,<span class="number">0x4b</span>,<span class="number">0x70</span>,<span class="number">0x56</span>,<span class="number">0x9d</span>,<span class="number">0x35</span>,</span><br><span class="line">	<span class="number">0x1e</span>,<span class="number">0x24</span>,<span class="number">0x0e</span>,<span class="number">0x5e</span>,<span class="number">0x63</span>,<span class="number">0x58</span>,<span class="number">0xd1</span>,<span class="number">0xa2</span>,<span class="number">0x25</span>,<span class="number">0x22</span>,<span class="number">0x7c</span>,<span class="number">0x3b</span>,<span class="number">0x01</span>,<span class="number">0x21</span>,<span class="number">0x78</span>,<span class="number">0x87</span>,</span><br><span class="line">	<span class="number">0xd4</span>,<span class="number">0x00</span>,<span class="number">0x46</span>,<span class="number">0x57</span>,<span class="number">0x9f</span>,<span class="number">0xd3</span>,<span class="number">0x27</span>,<span class="number">0x52</span>,<span class="number">0x4c</span>,<span class="number">0x36</span>,<span class="number">0x02</span>,<span class="number">0xe7</span>,<span class="number">0xa0</span>,<span class="number">0xc4</span>,<span class="number">0xc8</span>,<span class="number">0x9e</span>,</span><br><span class="line">	<span class="number">0xea</span>,<span class="number">0xbf</span>,<span class="number">0x8a</span>,<span class="number">0xd2</span>,<span class="number">0x40</span>,<span class="number">0xc7</span>,<span class="number">0x38</span>,<span class="number">0xb5</span>,<span class="number">0xa3</span>,<span class="number">0xf7</span>,<span class="number">0xf2</span>,<span class="number">0xce</span>,<span class="number">0xf9</span>,<span class="number">0x61</span>,<span class="number">0x15</span>,<span class="number">0xa1</span>,</span><br><span class="line">	<span class="number">0xe0</span>,<span class="number">0xae</span>,<span class="number">0x5d</span>,<span class="number">0xa4</span>,<span class="number">0x9b</span>,<span class="number">0x34</span>,<span class="number">0x1a</span>,<span class="number">0x55</span>,<span class="number">0xad</span>,<span class="number">0x93</span>,<span class="number">0x32</span>,<span class="number">0x30</span>,<span class="number">0xf5</span>,<span class="number">0x8c</span>,<span class="number">0xb1</span>,<span class="number">0xe3</span>,</span><br><span class="line">	<span class="number">0x1d</span>,<span class="number">0xf6</span>,<span class="number">0xe2</span>,<span class="number">0x2e</span>,<span class="number">0x82</span>,<span class="number">0x66</span>,<span class="number">0xca</span>,<span class="number">0x60</span>,<span class="number">0xc0</span>,<span class="number">0x29</span>,<span class="number">0x23</span>,<span class="number">0xab</span>,<span class="number">0x0d</span>,<span class="number">0x53</span>,<span class="number">0x4e</span>,<span class="number">0x6f</span>,</span><br><span class="line">	<span class="number">0xd5</span>,<span class="number">0xdb</span>,<span class="number">0x37</span>,<span class="number">0x45</span>,<span class="number">0xde</span>,<span class="number">0xfd</span>,<span class="number">0x8e</span>,<span class="number">0x2f</span>,<span class="number">0x03</span>,<span class="number">0xff</span>,<span class="number">0x6a</span>,<span class="number">0x72</span>,<span class="number">0x6d</span>,<span class="number">0x6c</span>,<span class="number">0x5b</span>,<span class="number">0x51</span>,</span><br><span class="line">	<span class="number">0x8d</span>,<span class="number">0x1b</span>,<span class="number">0xaf</span>,<span class="number">0x92</span>,<span class="number">0xbb</span>,<span class="number">0xdd</span>,<span class="number">0xbc</span>,<span class="number">0x7f</span>,<span class="number">0x11</span>,<span class="number">0xd9</span>,<span class="number">0x5c</span>,<span class="number">0x41</span>,<span class="number">0x1f</span>,<span class="number">0x10</span>,<span class="number">0x5a</span>,<span class="number">0xd8</span>,</span><br><span class="line">	<span class="number">0x0a</span>,<span class="number">0xc1</span>,<span class="number">0x31</span>,<span class="number">0x88</span>,<span class="number">0xa5</span>,<span class="number">0xcd</span>,<span class="number">0x7b</span>,<span class="number">0xbd</span>,<span class="number">0x2d</span>,<span class="number">0x74</span>,<span class="number">0xd0</span>,<span class="number">0x12</span>,<span class="number">0xb8</span>,<span class="number">0xe5</span>,<span class="number">0xb4</span>,<span class="number">0xb0</span>,</span><br><span class="line">	<span class="number">0x89</span>,<span class="number">0x69</span>,<span class="number">0x97</span>,<span class="number">0x4a</span>,<span class="number">0x0c</span>,<span class="number">0x96</span>,<span class="number">0x77</span>,<span class="number">0x7e</span>,<span class="number">0x65</span>,<span class="number">0xb9</span>,<span class="number">0xf1</span>,<span class="number">0x09</span>,<span class="number">0xc5</span>,<span class="number">0x6e</span>,<span class="number">0xc6</span>,<span class="number">0x84</span>,</span><br><span class="line">	<span class="number">0x18</span>,<span class="number">0xf0</span>,<span class="number">0x7d</span>,<span class="number">0xec</span>,<span class="number">0x3a</span>,<span class="number">0xdc</span>,<span class="number">0x4d</span>,<span class="number">0x20</span>,<span class="number">0x79</span>,<span class="number">0xee</span>,<span class="number">0x5f</span>,<span class="number">0x3e</span>,<span class="number">0xd7</span>,<span class="number">0xcb</span>,<span class="number">0x39</span>,<span class="number">0x48</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> u32 FK[<span class="number">4</span>] = &#123;</span><br><span class="line">	<span class="number">0xa3b1bac6</span>, <span class="number">0x56aa3350</span>, <span class="number">0x677d9197</span>, <span class="number">0xb27022dc</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> u32 CK[<span class="number">32</span>] = &#123;</span><br><span class="line">	<span class="number">0x00070e15</span>, <span class="number">0x1c232a31</span>, <span class="number">0x383f464d</span>, <span class="number">0x545b6269</span>,</span><br><span class="line">	<span class="number">0x70777e85</span>, <span class="number">0x8c939aa1</span>, <span class="number">0xa8afb6bd</span>, <span class="number">0xc4cbd2d9</span>,</span><br><span class="line">	<span class="number">0xe0e7eef5</span>, <span class="number">0xfc030a11</span>, <span class="number">0x181f262d</span>, <span class="number">0x343b4249</span>,</span><br><span class="line">	<span class="number">0x50575e65</span>, <span class="number">0x6c737a81</span>, <span class="number">0x888f969d</span>, <span class="number">0xa4abb2b9</span>,</span><br><span class="line">	<span class="number">0xc0c7ced5</span>, <span class="number">0xdce3eaf1</span>, <span class="number">0xf8ff060d</span>, <span class="number">0x141b2229</span>,</span><br><span class="line">	<span class="number">0x30373e45</span>, <span class="number">0x4c535a61</span>, <span class="number">0x686f767d</span>, <span class="number">0x848b9299</span>,</span><br><span class="line">	<span class="number">0xa0a7aeb5</span>, <span class="number">0xbcc3cad1</span>, <span class="number">0xd8dfe6ed</span>, <span class="number">0xf4fb0209</span>,</span><br><span class="line">	<span class="number">0x10171e25</span>, <span class="number">0x2c333a41</span>, <span class="number">0x484f565d</span>, <span class="number">0x646b7279</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">u32 <span class="title">functionB</span><span class="params">(u32 b)</span> </span>&#123;</span><br><span class="line">    u8 a[<span class="number">4</span>];</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    a[<span class="number">0</span>] = b / <span class="number">0x1000000</span>;</span><br><span class="line">    a[<span class="number">1</span>] = b / <span class="number">0x10000</span>;</span><br><span class="line">    a[<span class="number">2</span>] = b / <span class="number">0x100</span>;</span><br><span class="line">    a[<span class="number">3</span>] = b;</span><br><span class="line">    b = Sbox[a[<span class="number">0</span>]] * <span class="number">0x1000000</span> + Sbox[a[<span class="number">1</span>]] * <span class="number">0x10000</span> + Sbox[a[<span class="number">2</span>]] * <span class="number">0x100</span> + Sbox[a[<span class="number">3</span>]];</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">u32 <span class="title">loopLeft</span><span class="params">(u32 a, <span class="type">short</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        a = a * <span class="number">2</span> + a / <span class="number">0x80000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">u32 <span class="title">functionL1</span><span class="params">(u32 a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a ^ <span class="built_in">loopLeft</span>(a, <span class="number">2</span>) ^ <span class="built_in">loopLeft</span>(a, <span class="number">10</span>) ^ <span class="built_in">loopLeft</span>(a, <span class="number">18</span>) ^ <span class="built_in">loopLeft</span>(a, <span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">u32 <span class="title">functionL2</span><span class="params">(u32 a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a ^ <span class="built_in">loopLeft</span>(a, <span class="number">13</span>) ^ <span class="built_in">loopLeft</span>(a, <span class="number">23</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">u32 <span class="title">functionT</span><span class="params">(u32 a, <span class="type">short</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mode == <span class="number">1</span> ? <span class="built_in">functionL1</span>(<span class="built_in">functionB</span>(a)) : <span class="built_in">functionL2</span>(<span class="built_in">functionB</span>(a));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">getRK</span><span class="params">(u32 MK[], u32 K[], u32 RK[])</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        K[i] = MK[i] ^ FK[i]; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        K[(i+<span class="number">4</span>)%<span class="number">4</span>] = K[i%<span class="number">4</span>] ^ <span class="built_in">functionT</span>(K[(i+<span class="number">1</span>)%<span class="number">4</span>] ^ K[(i+<span class="number">2</span>)%<span class="number">4</span>] ^ K[(i+<span class="number">3</span>)%<span class="number">4</span>] ^ CK[i], <span class="number">2</span>);</span><br><span class="line">        RK[i] = K[(i+<span class="number">4</span>)%<span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">iterate32</span><span class="params">(u32 X[], u32 RK[])</span> </span>&#123;</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        X[(i+<span class="number">4</span>)%<span class="number">4</span>] = X[i%<span class="number">4</span>] ^ <span class="built_in">functionT</span>(X[(i+<span class="number">1</span>)%<span class="number">4</span>] ^ X[(i+<span class="number">2</span>)%<span class="number">4</span>] ^ X[(i+<span class="number">3</span>)%<span class="number">4</span>] ^ RK[i], <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reverse</span><span class="params">(u32 X[], u32 Y[])</span> </span>&#123;</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">        Y[i] = X[<span class="number">4</span> - <span class="number">1</span> - i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">encryptSM4</span><span class="params">(u32 X[], u32 RK[], u32 Y[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">iterate32</span>(X, RK);</span><br><span class="line">    <span class="built_in">reverse</span>(X, Y);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decryptSM4</span><span class="params">(u32 X[], u32 RK[], u32 Y[])</span> </span>&#123;</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    u32 reverseRK[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        reverseRK[i] = RK[<span class="number">32</span><span class="number">-1</span>-i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">iterate32</span>(X, reverseRK);</span><br><span class="line">    <span class="built_in">reverse</span>(X, Y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    u32 X[<span class="number">4</span>];</span><br><span class="line">    u32 MK[<span class="number">4</span>];</span><br><span class="line">    u32 RK[<span class="number">32</span>];</span><br><span class="line">    u32 K[<span class="number">4</span>];</span><br><span class="line">    u32 Y[<span class="number">4</span>];</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    <span class="type">int</span> a, b, c;</span><br><span class="line">    <span class="keyword">for</span>(a = <span class="number">0</span>; a &lt; <span class="number">255</span>; a++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, a);</span><br><span class="line">        <span class="keyword">for</span>(b = <span class="number">0</span>; b &lt; <span class="number">255</span>; b++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(c = <span class="number">0</span>; c &lt; <span class="number">255</span>; c++)</span><br><span class="line">            &#123;</span><br><span class="line">                MK[<span class="number">0</span>] = <span class="number">0xa9873700</span> + a;</span><br><span class="line">                MK[<span class="number">1</span>] = <span class="number">0xf75b8a00</span> + b;</span><br><span class="line">                MK[<span class="number">2</span>] = <span class="number">0xfe911800</span> + c;</span><br><span class="line">                MK[<span class="number">3</span>] = <span class="number">0x705ade09</span>;</span><br><span class="line">                X[<span class="number">0</span>] = <span class="number">0xCACEE1CC</span>;</span><br><span class="line">                X[<span class="number">1</span>] = <span class="number">0xD5D2BAA3</span>;</span><br><span class="line">                X[<span class="number">2</span>] = <span class="number">0xCDBEF5CA</span>;</span><br><span class="line">                X[<span class="number">3</span>] = <span class="number">0xBFA3C7CA</span>;</span><br><span class="line">                <span class="built_in">getRK</span>(MK, K, RK);</span><br><span class="line">                <span class="built_in">encryptSM4</span>(X, RK, Y);</span><br><span class="line">                <span class="keyword">if</span>(Y[<span class="number">0</span>] == <span class="number">0x97d579f4</span> &amp;&amp; Y[<span class="number">1</span>] == <span class="number">0xdfa9f2c7</span> &amp;&amp; Y[<span class="number">2</span>] == <span class="number">0x5d2daae7</span> &amp;&amp; Y[<span class="number">3</span>] == <span class="number">0x204bffbb</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;正确秘钥：%d %d %d\n&quot;</span>, a, b, c);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4分钟之后可以解得正确秘钥：241 129 204。<br>
得到flag：TSCTF-J{99B099BA10008E22180634253E984A88}</p>
<h2 id="the-native">The_Native</h2>
<p>本文采用JEB作为反汇编软件。<br>
打开后可以在Manifest中找到程序的入口点是com.linjhs.ezandroid.MainActivity：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Native1.png" alt=""><br>
它调用了两个本地的库，一个叫MyString()，一个是Cal()。将libezandroid.so提取出来并用IDA打开后就可以找到他们。<br>
对于MyString()，它只是将数据提取了出来然后返回。<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Native2.png" alt=""><br>
对于Cal()，有用的部分只有异或0xC。<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Native3.png" alt=""><br>
在MainActivity中可以找到异或52。因此可以写出解题代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> v[] = &#123;<span class="number">108</span>, <span class="number">107</span>, <span class="number">123</span>, <span class="number">108</span>, <span class="number">126</span>, <span class="number">21</span>, <span class="number">114</span>, <span class="number">67</span>, <span class="number">108</span>, <span class="number">80</span>, <span class="number">93</span>, <span class="number">103</span>, <span class="number">86</span>, <span class="number">89</span>, <span class="number">76</span>, <span class="number">81</span>, <span class="number">110</span>, <span class="number">93</span>, <span class="number">103</span>, <span class="number">89</span>, <span class="number">84</span>, <span class="number">79</span>, <span class="number">89</span>, <span class="number">65</span>, <span class="number">13</span>, <span class="number">103</span>, <span class="number">80</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">72</span>, <span class="number">103</span>, <span class="number">65</span>, <span class="number">8</span>, <span class="number">77</span>, <span class="number">25</span>, <span class="number">69</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(v); i++)</span><br><span class="line">        v[i] ^= <span class="number">52</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(v); i++)</span><br><span class="line">        v[i] ^= <span class="number">12</span>;</span><br><span class="line">    cout &lt;&lt; v;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行得出flag：TSCTF-J{The_natiVe_alway5_h31p_y0u!}</p>
<h2 id="the-devil">The_Devil</h2>
<p>虚拟机逆向。感受脑干在未知的地方被碾得支离破碎的感觉吧！哈哈哈哈哈哈哈！<br>
经过分析可以得出：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Devil1.png" alt=""><br>
VirtualMachineInit()将寄存器及zf指示位置零。VirtualMachine1()分析后如下：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Devil2.png" alt=""><br>
其中reg[0]是eip，reg[1]~reg[4]是eax,ebx,ecx,edx，reg[5]是zf指示位。<br>
可以看出case1X是mov指令、case2X是add指令、case3X是sub指令、case4X是xor指令、case5X是imul指令、case6X是自创模运算modul指令、case7X是and指令、case8X是or指令、case90是not指令、case100是cmp指令、case110是jne指令、case111是je指令、case255是retn指令。再根据opcode可以复现出汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mov   eax, 0                15,1,0,</span><br><span class="line">Label1:</span><br><span class="line">mov   ebx, input[eax]       12,2,1,</span><br><span class="line">sub   ebx, eax              30,2,1,</span><br><span class="line">imul  ebx, 4                55,2,4,</span><br><span class="line">mov   intarray[eax], ebx    13,1,2,</span><br><span class="line">add   eax, 1                25,1,1,</span><br><span class="line">mov   ebx, 64               15,2,64,</span><br><span class="line">cmp   eax, ebx              100,1,2,</span><br><span class="line">jne   Label1                110,3,</span><br><span class="line"></span><br><span class="line">mov   eax, 0                15,1,0,</span><br><span class="line">Label2:</span><br><span class="line">mov   ebx, eax              10,2,1,</span><br><span class="line">add   ebx, 8                25,2,8,</span><br><span class="line">modul ebx, 64               65,2,64,</span><br><span class="line">mov   ecx, intarray[eax]    14,3,1,</span><br><span class="line">not   ecx                   90,3,</span><br><span class="line">and   ecx, intarray[ebx]    74,3,2,</span><br><span class="line">mov   edx, intarray[ebx]    14,4,2,</span><br><span class="line">not   edx                   90,4,</span><br><span class="line">and   edx, intarray[eax]    74,4,1,</span><br><span class="line">or    ecx, edx              80,3,4,</span><br><span class="line">mov   intarray[eax], ecx    13,1,3,</span><br><span class="line">add   eax, 1                25,1,1,</span><br><span class="line">mov   ecx, eax              10,3,1,</span><br><span class="line">xor   ecx, 64               45,3,64,</span><br><span class="line">mov   edx, 0                15,4,0,</span><br><span class="line">cmp   ecx, edx              100,3,4,</span><br><span class="line">jne   Label2                110,29,</span><br><span class="line">retn                        255</span><br></pre></td></tr></table></figure>
<p>把上面的主要部分翻译成人话就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input[i] -= i;</span><br><span class="line">input[i] *= 4;</span><br><span class="line">input[i] ^= input[(i + 8) % 64];</span><br></pre></td></tr></table></figure>
<p>VirtualMachine2()可分析如下：<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Devil3.png" alt=""><br>
这一部分的加密由reg作为索引，进行或非操作。而此部分的opcode是加密过的，每次用完又会加密回去。加密所用的key明面上是&quot;Clovershrub&quot;，动调可以发现实际上是&quot;ClovershrubHMS&quot;。可以考虑将所有的opcode自行解密，本文采用设置条件断点，让IDA输出的方法。<br>
<img src="/img/%5BTSCTF-J2023%5D%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3/The_Devil4.png" alt=""><br>
IDAPython脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">reg_addr = <span class="number">0x00007FF65F3097D0</span></span><br><span class="line">rsp = idc.get_reg_value(<span class="string">&#x27;rsp&#x27;</span>)</span><br><span class="line">p0 = ida_bytes.get_dword(rsp + <span class="number">0x28</span>)</span><br><span class="line">p1 = ida_bytes.get_dword(rsp + <span class="number">0x24</span>)</span><br><span class="line">p2 = ida_bytes.get_dword(rsp + <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> p1 &amp; <span class="number">0x80000000</span> != <span class="number">0</span>:</span><br><span class="line">    p1 = -(<span class="number">0xffffffff</span> - p1 + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> p2 &amp; <span class="number">0x80000000</span> != <span class="number">0</span>:</span><br><span class="line">    p2 = -(<span class="number">0xffffffff</span> - p2 + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">reg_p1 = ida_bytes.get_dword(reg_addr + p1 * <span class="number">4</span>)</span><br><span class="line">reg_p2 = ida_bytes.get_dword(reg_addr + p2 * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> reg_p1 &amp; <span class="number">0x80000000</span> != <span class="number">0</span>:</span><br><span class="line">    reg_p1 = -(<span class="number">0xffffffff</span> - reg_p1 + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> reg_p2 &amp; <span class="number">0x80000000</span> != <span class="number">0</span>:</span><br><span class="line">    reg_p2 = -(<span class="number">0xffffffff</span> - reg_p2 + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;reg[%d] = ~(reg[%d] | reg[%d]) &quot;</span>%(p0, p1, p2), <span class="string">&quot;reg[%d] = ~( %d | %d )&quot;</span>%(p0, reg_p1, reg_p2))</span><br></pre></td></tr></table></figure>
<p>在输出窗口可以看见他吐出来了一大堆东西。可对其进行分组，这是其中的第一个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">reg[1] = ~(reg[8] | reg[8])        reg[1] = ~( 0 | 0 )</span><br><span class="line">reg[2] = ~(reg[-432] | reg[-432])  reg[2] = ~( 76 | 76 )</span><br><span class="line">reg[2] = ~(reg[2] | reg[2])        reg[2] = ~( -77 | -77 )</span><br><span class="line">reg[3] = ~(reg[2] | reg[1])        reg[3] = ~( 76 | -1 )</span><br><span class="line">reg[1] = ~(reg[8] | reg[8])        reg[1] = ~( 0 | 0 )</span><br><span class="line">reg[1] = ~(reg[1] | reg[1])        reg[1] = ~( -1 | -1 )</span><br><span class="line">reg[2] = ~(reg[-432] | reg[-432])  reg[2] = ~( 76 | 76 )</span><br><span class="line">reg[4] = ~(reg[2] | reg[1])        reg[4] = ~( -77 | 0 )</span><br><span class="line">reg[1] = ~(reg[4] | reg[3])        reg[1] = ~( 76 | 0 )</span><br><span class="line">reg[8] = ~(reg[1] | reg[1])        reg[8] = ~( -77 | -77 )</span><br></pre></td></tr></table></figure>
<p>通过观察可以找到reg[8]就是intarray[0]，reg[-432]是另一个数组——text[]的首位元素。进IDA查找可以知道text[]=“LoveCanConquerEverything”。分析或非操作可知其实就是在进行异或操作。我们可以写出解题代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> enc[<span class="number">100</span>] = &#123;<span class="number">88</span>, <span class="number">191</span>, <span class="number">222</span>, <span class="number">113</span>, <span class="number">215</span>, <span class="number">353</span>, <span class="number">42</span>, <span class="number">195</span>, <span class="number">127</span>, <span class="number">126</span>, <span class="number">89</span>, <span class="number">105</span>, <span class="number">125</span>, <span class="number">142</span>, <span class="number">73</span>, <span class="number">174</span>, <span class="number">45</span>, <span class="number">214</span>, <span class="number">193</span>, <span class="number">88</span>, <span class="number">188</span>, <span class="number">21</span>, <span class="number">14</span>, <span class="number">219</span>, <span class="number">68</span>, <span class="number">79</span>, <span class="number">446</span>, <span class="number">65</span>, <span class="number">3</span>, <span class="number">65</span>, <span class="number">434</span>, <span class="number">387</span>, <span class="number">399</span>, <span class="number">86</span>, <span class="number">121</span>, <span class="number">53</span>, <span class="number">441</span>, <span class="number">90</span>, <span class="number">77</span>, <span class="number">406</span>, <span class="number">113</span>, <span class="number">422</span>, <span class="number">117</span>, <span class="number">448</span>, <span class="number">420</span>, <span class="number">397</span>, <span class="number">114</span>, <span class="number">459</span>, <span class="number">24</span>, <span class="number">23</span>, <span class="number">46</span>, <span class="number">77</span>, <span class="number">439</span>, <span class="number">117</span>, <span class="number">-238</span>, <span class="number">3</span>, <span class="number">207</span>, <span class="number">38</span>, <span class="number">113</span>, <span class="number">249</span>, <span class="number">5</span>, <span class="number">426</span>, <span class="number">-115</span>, <span class="number">14</span>&#125;;</span><br><span class="line">    <span class="type">char</span> text[<span class="number">50</span>] = <span class="string">&quot;LoveCanConquerEverything&quot;</span>;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        enc[i] ^= text[i % <span class="number">24</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">63</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        enc[i] ^= enc[(i + <span class="number">8</span>) % <span class="number">64</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        enc[i] /= <span class="number">4</span>;</span><br><span class="line">        enc[i] += i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, enc[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行得出flag：TSCTF-J{You_successfully_dispelled_the_devil_within_three_days!}</p>
<h2 id="后记">后记</h2>
<p>这次经历还是收获了很多的。在赛前去各个网站扒往年的题学习它们的设计和解题的方法、赛中给选手回答问题都让我受益匪浅。要说遗憾的话可能是今年的题出得确实有点难，没见到几个成功屠龙的猛士。在看大家写得题解的时候发现有的师傅放弃一道题的原因竟然是害怕接下来还会有坑。哎，为什么要把我想象得如此邪恶。呜呜呜呜呜( ಥ _ ಥ )</p>
<p>不过你们应该还是挺喜欢我出的题的，对吧对吧？( ≧ ∇ ≦ ) /</p>
</article><div class="tag_share"><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/11/28/pwn%E4%BD%A0%E5%A6%88/" title="pwn你妈"><img class="cover" src="/img/pwn%E4%BD%A0%E5%A6%88/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">pwn你妈</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/06/BUUCTF%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E-1/" title="BUUCTF二进制漏洞-1"><img class="cover" src="/img/BUUCTF%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E-1/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">BUUCTF二进制漏洞-1</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/blogs/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Clovershrub</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#tsctf-j2023-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E9%A2%98%E8%A7%A3"><span class="toc-text">[TSCTF-J2023]逆向工程题解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-path"><span class="toc-text">The_Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-encryption"><span class="toc-text">The_Encryption</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-gobang"><span class="toc-text">The_GoBang</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-step"><span class="toc-text">The_Step</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-magic"><span class="toc-text">The_Magic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-shell"><span class="toc-text">The_Shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-art"><span class="toc-text">The_Art</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-native"><span class="toc-text">The_Native</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-devil"><span class="toc-text">The_Devil</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">后记</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/20/%5BTSCTF-J2024%5D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%A2%98%E8%A7%A3/" title="[TSCTF-J2024]二进制漏洞题解"><img src="/img/%5BTSCTF-J2024%5D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%A2%98%E8%A7%A3/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[TSCTF-J2024]二进制漏洞题解"/></a><div class="content"><a class="title" href="/2024/09/20/%5BTSCTF-J2024%5D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%A2%98%E8%A7%A3/" title="[TSCTF-J2024]二进制漏洞题解">[TSCTF-J2024]二进制漏洞题解</a><time datetime="2024-09-19T16:00:00.000Z" title="Created 2024-09-20 00:00:00">2024-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/19/DubheCTF-Destination&amp;Moon/" title="DubheCTF-Destination&amp;Moon"><img src="/img/DubheCTF-Destination&amp;Moon/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DubheCTF-Destination&amp;Moon"/></a><div class="content"><a class="title" href="/2024/03/19/DubheCTF-Destination&amp;Moon/" title="DubheCTF-Destination&amp;Moon">DubheCTF-Destination&amp;Moon</a><time datetime="2024-03-18T16:00:00.000Z" title="Created 2024-03-19 00:00:00">2024-03-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/02/%E5%A4%A9%E5%A0%82%E4%B9%8B%E9%97%A8/" title="天堂之门"><img src="/img/%E5%A4%A9%E5%A0%82%E4%B9%8B%E9%97%A8/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天堂之门"/></a><div class="content"><a class="title" href="/2024/02/02/%E5%A4%A9%E5%A0%82%E4%B9%8B%E9%97%A8/" title="天堂之门">天堂之门</a><time datetime="2024-02-01T16:00:00.000Z" title="Created 2024-02-02 00:00:00">2024-02-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/26/%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B/" title="傀儡进程"><img src="/img/%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B/cover.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="傀儡进程"/></a><div class="content"><a class="title" href="/2024/01/26/%E5%82%80%E5%84%A1%E8%BF%9B%E7%A8%8B/" title="傀儡进程">傀儡进程</a><time datetime="2024-01-25T16:00:00.000Z" title="Created 2024-01-26 00:00:00">2024-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/23/COM%E5%8A%AB%E6%8C%81%E5%AE%9E%E7%8E%B0%E6%8F%90%E6%9D%83/" title="COM劫持实现提权"><img src="/img/COM%E5%8A%AB%E6%8C%81%E5%AE%9E%E7%8E%B0%E6%8F%90%E6%9D%83/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="COM劫持实现提权"/></a><div class="content"><a class="title" href="/2024/01/23/COM%E5%8A%AB%E6%8C%81%E5%AE%9E%E7%8E%B0%E6%8F%90%E6%9D%83/" title="COM劫持实现提权">COM劫持实现提权</a><time datetime="2024-01-22T16:00:00.000Z" title="Created 2024-01-23 00:00:00">2024-01-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/blogs/foot.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By Clovershrub</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="255,0,150" opacity="0.7" zIndex="-1" count="200" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>